//
//  JSRootWebViewController.m
//  JSBankCCYRemastered
//
//  Created by Jack on 2019/5/9.
//  Copyright © 2019 Jack. All rights reserved.
//

#import "JSRootWebViewController.h"
#import "JSSearchViewController.h"
#import "JSScanViewController.h"
#import "JSLoginViewController.h"
#import "JSSettingPasswordViewController.h"
#import "IndexTab.h"
#import "SharePagesH5Plugin.h"

@interface JSRootWebViewController () <UIScrollViewDelegate>
/*顶部搜索框*/
@property(nonatomic,strong)UIImageView *searchImageView;
@property(nonatomic,strong)UIImageView *leftIcon;
@property(nonatomic,strong)UIButton    *rightIcon;

@end

@implementation JSRootWebViewController

- (void)viewDidLayoutSubviews {
    [super viewDidLayoutSubviews];
    
    self.searchImageView.layer.cornerRadius = self.searchImageView.frame.size.height / 2;
}

- (void)viewWillLayoutSubviews {
    [super viewWillLayoutSubviews];
    
    self.bankWebView.scrollView.delegate = self;
    self.bankWebView.scrollView.mj_header = self.header;
}

- (MJRefreshNormalHeader *)header {
    if (!_header) {
        _header = [MJRefreshNormalHeader headerWithRefreshingTarget:self refreshingAction:@selector(doWebRequest)];
        [_header setTitle:@"下拉刷新加载更多" forState:MJRefreshStateIdle];
        [_header setTitle:@"松开刷新载更多" forState:MJRefreshStatePulling];
        [_header setTitle:@"数据加载中...." forState:MJRefreshStateRefreshing];
        [_header setTitle:@"没有更多数据...." forState:MJRefreshStateNoMoreData];
        _header.lastUpdatedTimeLabel.hidden = YES;
        _header.stateLabel.font = [UIFont systemFontOfSize:13];
        _header.stateLabel.textColor = Color().Auxiliary;
    }
    return _header;
}

- (void)viewDidLoad {
    [super viewDidLoad];
    
    
    //[self addNavigationSearchBar];
    self.navigationBar.separatorColor = [UIColor clearColor];
//    self.webProgess.hidden = YES;
    [self layoutSubControls];
//    dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(30 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
//
//        PCDContext *context = [[PCDContext alloc] init];
//        context.viewController = self;
//        NSDictionary *dict = @{@"index" : @"2"};
//        [[[IndexTab alloc] init] handler:dict andContext:context ResponseCallback:^(id responseData) {
//
//        }];
//    });
}

- (void)viewWillAppear:(BOOL)animated {
    [super viewWillAppear:animated];

    NSArray *vcs = [JSSharedInstance sharedInstance].viewControllers;
    NSArray *vcs1 = self.tabBarController.viewControllers;

    NSSet *set = [NSSet setWithArray:vcs];
    NSSet *set1 = [NSSet setWithArray:vcs1];
    if ([set isEqualToSet:set1]) {
        [JSLoginManager tipBiometry];
    }
}

- (void)addItemWithIconName:(NSString *)name leftItem:(BOOL)leftItem edgeInsets:(UIEdgeInsets)edgeInsets {
    CGFloat itemHeight = NAVI_HEIGHT - STATUSBAR_HEIGHT - 6;
    CGFloat iconSize = 22;
    
    UIView *bottomView = [[UIView alloc] init];
//    bottomView.backgroundColor = [UIColor redColor];
    bottomView.frame = CGRectMake(0, 0, 55, itemHeight);
    
    UIButton *button = [[UIButton alloc] init];
    button.hitTestEdgeInsets = UIEdgeInsetsMake(-20, -20, -20, -20);
    button.frame = CGRectMake((CGRectGetWidth(bottomView.frame) - iconSize) / 2, (CGRectGetHeight(bottomView.frame) - iconSize) / 2, iconSize, iconSize);
    [button setBackgroundImage:[UIImage imageNamed:name] forState:UIControlStateNormal];
    button.imageView.contentMode = UIViewContentModeScaleAspectFit;
    [bottomView addSubview:button];
    
    PCDBarButtonItem *item = [[PCDBarButtonItem alloc] initWithCustomView:bottomView];
    item.contentInsets = edgeInsets;
    if (leftItem) {
        self.navigationBar.leftBarButtonItem = item;
        [button addTarget:self action:@selector(leftBarButtonPressed) forControlEvents:UIControlEventTouchUpInside];
    } else {
        self.navigationBar.rightBarButtonItem = item;
        [button addTarget:self action:@selector(rightBarButtonPressed) forControlEvents:UIControlEventTouchUpInside];
    }
}

- (void)addNavigationSearchBar {
    self.searchImageView = [[UIImageView alloc] init];
    self.searchImageView.backgroundColor = [UIColor colorFormString:@"#f3f6f6"];
    self.searchImageView.layer.masksToBounds = YES;
    self.searchImageView.userInteractionEnabled = YES;
    [self.searchImageView addGestureRecognizer:[[UITapGestureRecognizer alloc] initWithTarget:self action:@selector(searchAction:)]];
    [self.navigationBar addSubview:self.searchImageView];

    self.leftIcon = [[UIImageView alloc] init];
    self.leftIcon.contentMode = UIViewContentModeScaleAspectFit;
    self.leftIcon.image = [UIImage imageNamed:@"searchIcon.png"];
    [self.searchImageView addSubview:self.leftIcon];
    
    self.rightIcon = [[UIButton alloc] init];
    self.rightIcon.hitTestEdgeInsets = UIEdgeInsetsMake(-20, -20, -20, -20);
    self.rightIcon.imageView.contentMode = UIViewContentModeScaleAspectFit;
    [self.rightIcon setImage:[UIImage imageNamed:@"service.png"] forState:UIControlStateNormal];
    [self.searchImageView addSubview:self.rightIcon];
    [self.rightIcon addTarget:self action:@selector(customerServiceFunc) forControlEvents:UIControlEventTouchUpInside];
    
    [self addItemWithIconName:@"message.png" leftItem:NO edgeInsets:UIEdgeInsetsZero];
    [self addItemWithIconName:@"scan.png" leftItem:YES edgeInsets:UIEdgeInsetsMake(0, -10, 0, 0)];
}

- (void)layoutSubControls {
    [self.searchImageView mas_makeConstraints:^(MASConstraintMaker *make) {
        make.top.mas_equalTo(self.navigationBar.mas_top).offset(STATUSBAR_HEIGHT + 6);
        make.bottom.mas_equalTo(self.navigationBar.mas_bottom).offset(-8);
        make.centerX.mas_equalTo(self.navigationBar.mas_centerX);
        make.width.mas_equalTo(Width - 55 * 2);
    }];
    [self.leftIcon mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_equalTo(self.searchImageView.mas_left).offset(10);
        make.width.height.mas_equalTo(20);
        make.centerY.mas_equalTo(self.searchImageView.mas_centerY);
    }];
    [self.rightIcon mas_makeConstraints:^(MASConstraintMaker *make) {
        make.right.mas_equalTo(self.searchImageView.mas_right).offset(-12);
        make.width.height.mas_equalTo(self.leftIcon);
        make.centerY.mas_equalTo(self.searchImageView.mas_centerY);
    }];
}

- (void)searchAction:(UIGestureRecognizer *)gesture {
//    [TouchIDManager saveBiometryStateDate];
}

- (void)customerServiceFunc {
//#if TARGET_IPHONE_SIMULATOR
//#else
//    JSFaceRecordViewController *faceVC = [[JSFaceRecordViewController alloc] init];
//    faceVC.type = @"1";
//    faceVC.callBackHandle=^(NSDictionary *dictData) {};
//    faceVC.hidesBottomBarWhenPushed = YES;
//    [self.tabBarController.navigationController pushViewController:faceVC animated:YES];
//#endif
//    JSBiometryLoginViewController *vc = [[JSBiometryLoginViewController alloc] init];
//    vc.hidesBottomBarWhenPushed = YES;
//    [self.tabBarController.navigationController pushViewController:vc animated:YES];
}

- (void)leftBarButtonPressed {
    JSScanViewController *scanVC = [[JSScanViewController alloc] init];
    scanVC.hidesBottomBarWhenPushed = YES;
    [self.tabBarController.navigationController pushViewController:scanVC animated:YES];
}
#pragma mark - webView右边按钮
- (void)rightBarButtonPressed {
//    if (([TouchIDManager biometryType] != DJBiometryTypeNotSupport) && ![TouchIDManager getBiometryState] && [JSLoginManager clientIsLogin] && ![TouchIDManager isWithinPeriod]) {
//        [JSDeftAlert showAlert:@"是否开启指纹登录" doneTitle:@"立即开启" cancelTitle:@"一周内不提示" doneHandle:^{
//            [JSBaseWebViewController goWebViewWithUrl:@"page/12/02/01/P0201.html"];
//        } cancelHandle:^{
//            [TouchIDManager saveBiometryStateDate];
//        }];
//    }
}
- (BOOL)webView:(UIWebView *)webView shouldStartLoadWithRequest:(NSURLRequest *)request navigationType:(UIWebViewNavigationType)navigationType {
    
    return YES;
}
- (void)webViewDidFinishLoad:(UIWebView *)webView {
    [self.bankWebView.scrollView.mj_header endRefreshing];
//    self.webProgess.progress = 1;
}
- (void)webViewDidStartLoad:(UIWebView *)webVie {
//    self.webProgess.progress = 0.3;
}

- (void)webView:(UIWebView *)webView didFailLoadWithError:(NSError *)error {
    NSLog(@"didFailLoadWithError");
    [self.bankWebView.scrollView.mj_header endRefreshing];
//    self.webProgess.progress = 0.0;
}

@end
