//
//  SocialShare.m
//  PNCMobileBank
//
//  Created by Apple on 15-4-14.
//  Copyright (c) 2015年 张瑞. All rights reserved.
//

#import "SocialShare.h"
#import "WXApi.h"
#import "WeiboSDK.h"
#import <ShareSDK/ShareSDK.h>
#import <MessageUI/MessageUI.h>
#import <ShareSDKUI/ShareSDK+SSUI.h>
#import <ShareSDKConnector/ShareSDKConnector.h>
#import <ShareSDKExtension/SSEThirdPartyLoginHelper.h>
#import <objc/runtime.h>


#define  dispatch_async_safe(block)  if ([NSThread isMainThread]) {\
block();}\
else{\
dispatch_async(dispatch_get_main_queue(), block);}

static const NSString *kMessageController=@"MessageController";

@interface SocialShare()

@property(nonatomic,assign)SSDKContentType type;

@property(nonatomic,copy)NSString *URL;

@property(nonatomic,strong)NSArray *phonesArray;

@property(nonatomic,assign)BOOL isWeb;

@end

@implementation SocialShare

@synthesize delegate=_delegate;

//+(void)share:(NSString *)imageURL shareController:(UIViewController *)shareVC  shareTitle:(NSString *)title shareDetailMSG:(NSString *)detailMessage shareType:(ShareType)type platformTypes:(NSDictionary *)platformTypes sharePhoneNumber:(NSString *)phoneNumber completeHandle:(void(^)(void))completeHandle
//{
//    NSMutableArray *platformArray=@[].mutableCopy;
//
//    for (NSNumber *type in platformTypes.allKeys)
//    {
//        if (type.integerValue==TypeForWechatTimeline)
//        {
//            [platformArray addObject:@(SSDKPlatformSubTypeWechatTimeline)];
//        }
//        else if (type.integerValue==TypeForWechatSession)
//        {
//            [platformArray addObject:@(SSDKPlatformSubTypeWechatSession)];
//        }
//        else if (type.integerValue==TypeForSinaWeb)
//        {
//            [platformArray addObject:@(SSDKPlatformTypeSinaWeibo)];
//        }
//        else if (type.integerValue==TypeForSMS)
//        {
//            [platformArray addObject:@(SSDKPlatformTypeSMS)];
//        }
//    }
//    //1、创建分享参数（必要）
//    NSMutableDictionary *shareParams = [NSMutableDictionary dictionary];
//
//    //优先使用平台客户端分享
//     [shareParams SSDKEnableUseClientShare];
//
//    //设置微博使用高级接口
//    [shareParams SSDKEnableAdvancedInterfaceShare];
//
//
//    if ([platformArray containsObject:@(SSDKPlatformTypeSinaWeibo)])
//    {
//       [shareParams SSDKSetupSinaWeiboShareParamsByText:[NSString stringWithFormat:@"%@%@",detailMessage, [platformTypes objectForKey:@(TypeForSinaWeb)]] title:title image:imageURL url:[NSURL URLWithString:[platformTypes objectForKey:@(TypeForSinaWeb)]] latitude:0 longitude:0 objectID:nil type:SSDKContentTypeAuto];
//    }
//   else if ([platformArray containsObject:@(SSDKPlatformSubTypeWechatSession)]) {
//
//         [shareParams SSDKSetupWeChatParamsByText:detailMessage title:title url:[NSURL URLWithString:[platformTypes objectForKey:@(TypeForWechatSession)]] thumbImage:nil image:imageURL musicFileURL:nil extInfo:nil fileData:nil emoticonData:nil type:SSDKContentTypeAuto forPlatformSubType:SSDKPlatformSubTypeWechatSession];
//    }
//  else  if ([platformArray containsObject:@(SSDKPlatformSubTypeWechatTimeline)])
//    {
//        //微信好友
//        [shareParams SSDKSetupWeChatParamsByText:detailMessage title:title url:[NSURL URLWithString:[platformTypes objectForKey:@(TypeForWechatTimeline)]] thumbImage:nil image:imageURL musicFileURL:nil extInfo:nil fileData:nil emoticonData:nil type:SSDKContentTypeAuto forPlatformSubType:SSDKPlatformSubTypeWechatTimeline];
//    }
//
//   else if ([platformArray containsObject:@(SSDKPlatformTypeSMS)])
//    {
//        [shareParams SSDKSetupSMSParamsByText:detailMessage title:title images:nil attachments:[NSURL URLWithString:[platformTypes objectForKey:@(TypeForSMS)]] recipients:@[phoneNumber] type:SSDKContentTypeText];
//    }
//
//    [ShareSDK showShareActionSheet:shareVC.view items:platformArray
//                       shareParams:shareParams onShareStateChanged:^(SSDKResponseState state, SSDKPlatformType platformType, NSDictionary *userData, SSDKContentEntity *contentEntity, NSError *error, BOOL end)
//     {
//
////         [JSSingletionInstance sharedSingletionInstance].canShare = YES;
//         switch (state)
//         {
//             case SSDKResponseStateBegin:
//                 break;
//
//             case SSDKResponseStateSuccess:
//             {
//                 completeHandle();
////                 //[PNCShareUtil showMessage:shareVC message:@"分享成功" completeHandle:nil];
//             }
//                 break;
//
//             case SSDKResponseStateFail:
//             {
////                  //[PNCShareUtil showMessage:shareVC message:@"分享失败" completeHandle:nil];
//             }
//                 break;
//             case SSDKResponseStateCancel:
//             {
////                 [JSSingletionInstance sharedSingletionInstance].canShare = YES;
//                 NSLog(@"取消分享");
//             }
//             break;
//             default:
//                 break;
//         }
//         if (state != SSDKResponseStateBegin){
//
//         }
//    }];
//}


+ (id)getImageSource:(NSString *)imageSource {
    if (!imageSource.notNull) {return nil;}
    
    if ([imageSource hasPrefix:@"http"] || [imageSource hasPrefix:@"https"]) {
        return imageSource;
    } else {
        NSData * imageData =[[NSData alloc] initWithBase64EncodedString:imageSource options:NSDataBase64DecodingIgnoreUnknownCharacters];
        UIImage *base64Image = [UIImage imageWithData:imageData ];
        return base64Image;
    }
    
    return nil;
}

+ (void)share:(NSArray *)dataArray shareController:(UIViewController *)shareVC shareNumber:(NSString *)phoneNumber completeHandle:(void(^)(NSString *callBack))completeHandle {
    
    NSMutableDictionary *shareParams = [NSMutableDictionary dictionary];
    NSMutableArray *platFormsArray=@[].mutableCopy;

    for (id obj in dataArray) {
        NSDictionary *dict=(NSDictionary *)obj;
        NSString *detailMessage=[dict objectForKey:@"SHARE_CONTENT"];
        NSString *title=[dict objectForKey:@"SHARE_TITLE"];
        NSString *imageSrc=[dict objectForKey:@"IMG_URL"];
        NSString *url=[dict objectForKey:@"LINK_URL"];
        NSString *type=[dict objectForKey:@"SHARE_TYPE"];

        //优先使用平台客户端分享
        [shareParams SSDKEnableUseClientShare];
        //设置微博使用高级接口
        [shareParams SSDKEnableAdvancedInterfaceShare];

        if ([type isEqualToString:@"01"]) {
            id image             = [self getImageSource:imageSrc];
            SSDKContentType type = [image isKindOfClass:[NSString class]] ? SSDKContentTypeAuto : SSDKContentTypeImage;

            [shareParams SSDKSetupSinaWeiboShareParamsByText:[NSString stringWithFormat:@"%@%@",detailMessage, url] title:title image:image url:[NSURL URLWithString:url] latitude:0 longitude:0 objectID:nil type:type];
            [platFormsArray addObject:@(SSDKPlatformTypeSinaWeibo)];
        } else if ([type isEqualToString:@"22"]) {
           id image             = [self getImageSource:imageSrc];
           SSDKContentType type = [image isKindOfClass:[NSString class]] ? SSDKContentTypeAuto : SSDKContentTypeImage;

            //微信好友
            [shareParams SSDKSetupWeChatParamsByText:detailMessage title:title url:[NSURL URLWithString:url] thumbImage:nil image:image musicFileURL:nil extInfo:nil fileData:nil emoticonData:nil type:type forPlatformSubType:SSDKPlatformSubTypeWechatSession];
            [platFormsArray addObject:@(SSDKPlatformSubTypeWechatSession)];
        } else if ([type isEqualToString:@"23"]) {
            id image             = [self getImageSource:imageSrc];
            SSDKContentType type = [image isKindOfClass:[NSString class]] ? SSDKContentTypeAuto : SSDKContentTypeImage;
            //微信朋友圈
            [shareParams SSDKSetupWeChatParamsByText:detailMessage title:title url:[NSURL URLWithString:url] thumbImage:nil image:image musicFileURL:nil extInfo:nil fileData:nil emoticonData:nil type:type forPlatformSubType:SSDKPlatformSubTypeWechatTimeline];
            [platFormsArray addObject:@(SSDKPlatformSubTypeWechatTimeline)];
        } else  if ([type isEqualToString:@"19"]) {
            [shareParams SSDKSetupSMSParamsByText:detailMessage title:title images:nil attachments:[NSURL URLWithString:url] recipients:@[phoneNumber] type:SSDKContentTypeText];
             [platFormsArray addObject:@(SSDKPlatformTypeSMS)];
        }
    }
    
    [ShareSDK showShareActionSheet:shareVC.view items:platFormsArray
                       shareParams:shareParams onShareStateChanged:^(SSDKResponseState state, SSDKPlatformType platformType, NSDictionary *userData, SSDKContentEntity *contentEntity, NSError *error, BOOL end) {
                           
                   switch (state) {
                       case SSDKResponseStateBegin:
                           
                           break;
                       case SSDKResponseStateSuccess:
                           for (NSDictionary *dict in dataArray) {
                               if ([[dict objectForKey:@"SHARE_TYPE"] integerValue]==platformType) {
                                   if ([dict objectForKey:@"callback"]) {
                                       completeHandle([dict objectForKey:@"callback"]);
                                   }
                               }
                           }
                           [JSDeftAlert showMessage:@"分享成功" afterDelay:2.0 completeHandle:nil];
                           break;
                       case SSDKResponseStateFail:
                           [JSDeftAlert showMessage:@"分享失败" afterDelay:2.0 completeHandle:nil];
                           break;
                       case SSDKResponseStateCancel:
                           
                           break;
                       default:
                           break;
                   }
         /*switch (state)
         {
             case SSDKResponseStateBegin:
                 break;
                 
             case SSDKResponseStateSuccess:
             {
                 for (NSDictionary *dict in dataArray)
                 {
                     if ([[dict objectForKey:@"SHARE_TYPE"] integerValue]==platformType)
                     {
                         if ([dict objectForKey:@"callback"]) {
                             completeHandle([dict objectForKey:@"callback"]);
                         }
                     }
                 }
//                 [PNCShareUtil showMessage:shareVC message:@"分享成功" completeHandle:nil];
                 NSLog(@"取消分享");
             }
             break;
                 
             case SSDKResponseStateFail:
             {
                 //[PNCShareUtil showMessage:shareVC message:@"分享失败" completeHandle:nil];
                 NSLog(@"分享失败");
                 NSLog(@"error : %@",error);
                 NSLog(@"shareParams : %@",shareParams);
             }
                 break;
             case SSDKResponseStateCancel:
             {
                 NSLog(@"取消分享");
             }
                 break;
             default:
                 break;
         }
         if (state != SSDKResponseStateBegin){
             
         }*/
     }];
}

@end
