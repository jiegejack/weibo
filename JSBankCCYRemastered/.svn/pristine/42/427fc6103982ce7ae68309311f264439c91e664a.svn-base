//
//  InitPageTitle.m
//  H5Container
//
//  Created by dk on 2018/6/7.
//  Copyright © 2018年 dk. All rights reserved.
//

#import "InitPageTitle.h"
#import <PCDUIBaseClass/PCDUIBaseClass.h>

@interface InitPageTitle()
@property (nonatomic, strong) JSBaseWebViewController *webView;

@property (nonatomic, strong) PCDWebNavigationDO *navDO;

/**
 *  右边按钮事件名称
 */
@property (nonatomic, strong) NSString *navRightButtonFun;
/**
 *  左边按钮事件名称
 */
@property (nonatomic, strong) NSString *navLeftButtonFun;
/**
 *导航栏元素颜色（左右按钮、导航栏标题）
 */
@property(nonatomic,strong)  UIColor *navigationTinColor;

@end

@implementation InitPageTitle

/*
 
 {
 leftButton =     {
 exist = true;
 func = "YT.prevPage()";
 icon = back;
 name = "\U8fd4\U56de";
 sort = 0;
 };
 rightButton =     {
 exist = false;
 };
 title = "\U666e\U901a\U9875\U9762";
 }
 
 */

- (void)handler:(id)data andContext:(PCDContext *)context ResponseCallback:(WVJBResponseCallback )responseCallback {
    self.webView = (JSBaseWebViewController *)context.viewController;

    NSDictionary *dict = (NSDictionary *)data;
    if (!dict.notNull) {return;}

    NSString *titleColorStr   = [dict valueForKey:@"tcolor"];
    NSString *naviBarColorStr = [dict valueForKey:@"background"];
    NSString *hide_Flag       = [dict valueForKey:@"hide"];
    //标题颜色
    self.navigationTinColor   = titleColorStr.notNull ? [UIColor colorFormString:titleColorStr]     : [UIColor blackColor];
    //导航栏颜色
    UIColor *naviBarColor     = naviBarColorStr.notNull ? [UIColor colorFormString:naviBarColorStr] : [UIColor whiteColor];

    //隐藏导航栏
    BOOL hiddenNaviBar = NO;
    if (hide_Flag.notNull) {hiddenNaviBar = hide_Flag.boolValue;}
    if (hiddenNaviBar) {
        self.webView.hiddenNaviBar = YES;
        return;
    }
    //初始化导航栏模型
    self.navDO = [[PCDWebNavigationDO alloc] initWithDict:dict];
    self.navDO.rightItemDO.itemTitle = @"确定";
    self.navDO.rightItemDO.isExist = YES;
    
    //设置标题
    self.webView.title = self.navDO.title.notNull ? self.navDO.title : @"";
    //设置左按钮
    if (self.navDO.leftItemDO.isExist) {
        self.webView.navigationBar.leftBarButtonItem = [self backBarButtonItem];
        self.navLeftButtonFun = self.navDO.leftItemDO.functionName;
    } else {
        self.navLeftButtonFun = nil;
        self.webView.navigationBar.leftBarButtonItem = nil;
    }
    //设置右边按钮
    if (self.navDO.rightItemDO.isExist) {
        self.webView.navigationBar.rightBarButtonItem = [self rightBarButtonItem];
        self.navRightButtonFun = self.navDO.rightItemDO.functionName;
    } else {
        self.navRightButtonFun = nil;
        self.webView.navigationBar.rightBarButtonItem = nil;
    }
    //导航栏背景色
    self.webView.navigationBar.backgroundColor = naviBarColor;

    //导航栏元素
    self.webView.navigationBar.titleItem.titleColor          = self.navigationTinColor;
    self.webView.navigationBar.leftBarButtonItem.titleColor  = self.navigationTinColor;
    self.webView.navigationBar.rightBarButtonItem.titleColor = self.navigationTinColor;
    
    
    [self.webView.navigationBar setNeedsLayout];
}

#pragma mark - 自定义返回按钮样式
- (PCDBarButtonItem *)backBarButtonItem {
//    UIImage *backImage = [self.webView.navigationBar.backgroundColor isEqual:[UIColor whiteColor]] ? [UIImage imageNamed:@"arrow_white"] : [UIImage imageNamed:@"arrow_black"];
    PCDBarButtonItem *backBarButtonItem =[[PCDBarButtonItem alloc]initWithImage:[UIImage imageNamed:@"leftArrow"] style:PCDBarButtonItemPlain target:self action:@selector(backBarButtonPressed)];
    backBarButtonItem.imageInsets = UIEdgeInsetsMake(0, 5, 0, 0);
    backBarButtonItem.imageSize = CGSizeMake(20, 20);
    
    return backBarButtonItem;
}

- (PCDBarButtonItem *)rightBarButtonItem {
    PCDBarButtonItem *rightItem =[[PCDBarButtonItem alloc]initWithTitle:self.navDO.rightItemDO.itemTitle target:self action:@selector(rightClick)];
    rightItem.titleInsets = UIEdgeInsetsMake(0, -20, 0, 0);
    rightItem.titleColor = self.navigationTinColor;
    
    return rightItem;
}

- (void)rightClick {
    if (self.navRightButtonFun.notNull) {
        evaluateJavaScriptOnMainThread(self, self.navRightButtonFun, @"");
    }
}

- (void)backBarButtonPressed {
    NSLog(@"func________ : %@",self.navLeftButtonFun);

//    if (self.navLeftButtonFun.notNull) {
//        evaluateJavaScriptOnMainThread(self, self.navLeftButtonFun, @"");
//    } else if ([self.webView.bankWebView canGoBack]) {
//        [self.webView.bankWebView goBack];
//    } else {
        [self.webView.tabBarController.navigationController popViewControllerAnimated:YES];
//    }
}

@end
