//
//  AmountKeyboard.m
//  JSBankCCYRemastered
//
//  Created by Jack on 2019/6/17.
//  Copyright © 2019 Jack. All rights reserved.
//

#import "AmountKeyboard.h"
#import "AmountView.h"

@interface AmountKeyboard ()
@property (nonatomic, strong) AmountView *amountView;

@end

@implementation AmountKeyboard

- (void)handler:(id)data andContext:(PCDContext *)context ResponseCallback:(WVJBResponseCallback )responseCallback {
    NSDictionary *dict = (NSDictionary *)data;
    if (!dict.notNull) {return;}
    NSString *callback =[dict objectForKey:@"callback"];
    NSString *title=[dict objectForKey:@"title"];
    NSString *endTitle=[dict objectForKey:@"endTitle"];
    BOOL isShowForget=[[dict objectForKey:@"isShowForget"] boolValue];
    NSString * url =[dict objectForKey:@"url"];
    NSString * transMoney    = [dict objectForKey:@"transMoney"];
    NSString * commodityName = [dict objectForKey:@"commodityName"];
    
    __weak typeof(self) weakSelf = self;
    self.amountView = [[AmountView alloc] initWithNickName:commodityName
                                                    amount:transMoney
                                                   tipText:endTitle
                                                showButton:isShowForget];
    
    self.amountView.inputPasswordBlock = ^(NSString * _Nonnull password) {
        NSLog(@"输入密码 : %@", password);
        evaluateJavaScriptOnMainThread(weakSelf, callback, password);
        [weakSelf.amountView dismiss];
    };
    self.amountView.titleLabel.text = title;
    self.amountView.buttonAction = ^{
        [weakSelf.amountView dismiss];
        [weakSelf goWebViewWithUrl:url];
    };
    [self.amountView show];
}

- (void)goWebViewWithUrl:(NSString *)url {
    if (!url.notNull) {
        return;
    }
    if (![url hasPrefix:@"https://"] || ![url hasPrefix:@"http://"]) {
        url = [PCDUtil getPublicServerURL:url];
    }
    NSDictionary *param = @{@"url" : url};
    NSDictionary *expando = [PCDUtil IsIphoneX]?@{@"NSLayoutAttributeTop":@"88"}:@{@"NSLayoutAttributeTop":@"64"};
    
    JSBaseWebViewController *webVC = [PCDWServiceGet() createPCDViewController:param viewControllerClass:[JSBaseWebViewController class] contentViewClass:nil withExpando:expando];
    UIWindow *window = [UIApplication sharedApplication].delegate.window;
    UINavigationController *navi = (UINavigationController *)window.rootViewController;
    [navi pushViewController:webVC animated:YES];
}

@end
