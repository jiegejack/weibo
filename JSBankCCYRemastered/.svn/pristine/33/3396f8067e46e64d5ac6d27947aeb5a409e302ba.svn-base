//
//  ShareReceiptH5Plugin.m
//  PCDBank
//
//  Created by 王俣 on 2018/9/21.
//  Copyright © 2018年 yt. All rights reserved.
//

#import "ShareReceiptH5Plugin.h"
#import "PCShareModel.h"
#import <ShareSDKUI/ShareSDKUI.h>

@implementation ShareReceiptH5Plugin

- (void)handler:(id)data andContext:(PCDContext *)context ResponseCallback:(WVJBResponseCallback )responseCallback {
    NSDictionary *dict = (NSDictionary *)data;
    NSString *type = dict[@"type"];
    NSArray *typeArr = [type componentsSeparatedByString:@","];
    NSString *callBack = dict[@"callback"];
    NSMutableArray *tmpArr = [NSMutableArray new];
    
    for (NSString *t in typeArr) {
        
        if ([t isEqualToString:@"WX"]) {
            [tmpArr addObject:@(SSDKPlatformSubTypeWechatSession)];
        }
        if ([t isEqualToString:@"PYQ"]) {
            [tmpArr addObject:@(SSDKPlatformSubTypeWechatTimeline)];
        }
        if ([t isEqualToString:@"QQ"]) {
            [tmpArr addObject:@(SSDKPlatformSubTypeQQFriend)];
        }
        if ([t isEqualToString:@"WB"]) {
            [tmpArr addObject:@(SSDKPlatformTypeSinaWeibo)];
        }
        if ([t isEqualToString:@"DX"]) {
            [tmpArr addObject:@(SSDKPlatformTypeSMS)];
        }
        if ([t isEqualToString:@"YX"]) {
            //            [tmpArr addObject:@(SSDKPlatformTypeMail)];
        }
    }
    
//    UIWebView *web =  self.bsContext.webView;
    JSBaseWebViewController *web = (JSBaseWebViewController *)context.eventTargetList.firstObject;
    UIImage *shotcut = [self imageRepresentationWithWebView:web];
    if (!shotcut) {return;}
    
    NSMutableDictionary *shareParams = [NSMutableDictionary dictionary];

//    [shareParams SSDKSetupSinaWeiboShareParamsByText:@"dssg" title:@"sdgsf" images:@[[UIImage imageNamed:@"test.png"]] video:nil url:nil latitude:0 longitude:0 objectID:nil isShareToStory:NO type:SSDKContentTypeImage];
    
    [shareParams SSDKSetupShareParamsByText:nil images:[UIImage imageNamed:@"test.png"] url:nil title:nil type:SSDKContentTypeImage];
    SSUIShareSheetConfiguration *config = [[SSUIShareSheetConfiguration alloc] init];

    [ShareSDK showShareActionSheet:nil customItems:tmpArr shareParams:shareParams sheetConfiguration:config onStateChanged:^(SSDKResponseState state, SSDKPlatformType platformType, NSDictionary *userData, SSDKContentEntity *contentEntity, NSError *error, BOOL end) {
        
        NSLog(@"error %@",error);
        //            BOOL qqInstalled = [ShareSDK isClientInstalled:SSDKPlatformTypeQQ];
        //            if (!qqInstalled) {
        //
        //                evaluateJavaScriptOnMainThread_quotes(self, callBack, @"qq未安装");
        //
        //                return ;
        //            }
        switch (state) {
            case SSDKResponseStateSuccess:
            {
                evaluateJavaScriptOnMainThread_quotes(self, callBack, @"分享成功");
                break;
            }
            case SSDKResponseStateFail:
            {
                evaluateJavaScriptOnMainThread_quotes(self, callBack, @"分享失败");
                break;
            }
            default:
                break;
        }
    }];
    
}

- (UIImage *)imageRepresentationWithWebView:(UIWebView *)webView{
    CGFloat scale = [UIScreen mainScreen].scale;
    
    CGSize boundsSize = webView.bounds.size;
    CGFloat boundsWidth = boundsSize.width;
    CGFloat boundsHeight = boundsSize.height;
    
    CGSize contentSize = webView.scrollView.contentSize;
    CGFloat contentHeight = contentSize.height;
    
    CGPoint offset = webView.scrollView.contentOffset;
    
    [webView.scrollView setContentOffset:CGPointMake(0, 0)];
    
    NSMutableArray *images = [NSMutableArray array];
    while (contentHeight > 0) {
        UIGraphicsBeginImageContextWithOptions(boundsSize, NO, 0.0);
        [webView.layer renderInContext:UIGraphicsGetCurrentContext()];
        UIImage *image = UIGraphicsGetImageFromCurrentImageContext();
        UIGraphicsEndImageContext();
        [images addObject:image];
        
        CGFloat offsetY = webView.scrollView.contentOffset.y;
        [webView.scrollView setContentOffset:CGPointMake(0, offsetY + boundsHeight)];
        contentHeight -= boundsHeight;
    }
    
    [webView.scrollView setContentOffset:offset];
    
    CGSize imageSize = CGSizeMake(contentSize.width * scale,
                                  contentSize.height * scale);
    UIGraphicsBeginImageContext(imageSize);
    [images enumerateObjectsUsingBlock:^(UIImage *image, NSUInteger idx, BOOL *stop) {
        [image drawInRect:CGRectMake(0,
                                     scale * boundsHeight * idx,
                                     scale * boundsWidth,
                                     scale * boundsHeight)];
    }];
    UIImage *fullImage = UIGraphicsGetImageFromCurrentImageContext();
    UIGraphicsEndImageContext();
    UIImageWriteToSavedPhotosAlbum(fullImage, nil, nil, nil);
    return fullImage;
}

- (void)screenView:(UIView *)view {
    // 设置截图大小
    UIGraphicsBeginImageContextWithOptions(CGSizeMake(Width,view.frame.size.height), YES, 0);
    [view.layer renderInContext:UIGraphicsGetCurrentContext()];
    UIImage *viewImage = UIGraphicsGetImageFromCurrentImageContext();
    UIGraphicsEndImageContext();
    CGImageRef imageRef = viewImage.CGImage;
    UIImage *sendImage = [[UIImage alloc] initWithCGImage:imageRef];
    NSLog(@"sendImage==%@",sendImage);
    //保存图片到照片库 （iOS10 以上记得在info.plist添加相册访问权限，否则可能崩溃）
    UIImageWriteToSavedPhotosAlbum(sendImage, nil, nil, nil);
}

@end
