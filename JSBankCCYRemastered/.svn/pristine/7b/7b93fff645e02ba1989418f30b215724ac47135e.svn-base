//
//  JSRootWebViewController.m
//  JSBankCCYRemastered
//
//  Created by Jack on 2019/5/9.
//  Copyright © 2019 Jack. All rights reserved.
//

#import "JSRootWebViewController.h"
#import "JSSearchViewController.h"
#import "JSScanViewController.h"
#import "JSLoginViewController.h"
#import "JSSettingPasswordViewController.h"
#import "WebPage.h"
#import "SharePagesH5Plugin.h"

@interface JSRootWebViewController () <UIScrollViewDelegate>
/*顶部搜索框*/
@property(nonatomic,strong)UIImageView *searchImageView;
@property(nonatomic,strong)UIImageView *leftIcon;
@property(nonatomic,strong)UIButton    *rightIcon;

@end

@implementation JSRootWebViewController

- (void)viewDidLayoutSubviews {
    [super viewDidLayoutSubviews];
    
    self.searchImageView.layer.cornerRadius = self.searchImageView.frame.size.height / 2;
}

- (void)viewWillLayoutSubviews {
    [super viewWillLayoutSubviews];
    
    self.bankWebView.scrollView.delegate = self;
    self.bankWebView.scrollView.mj_header = self.header;
}

- (MJRefreshNormalHeader *)header {
    if (!_header) {
        _header = [MJRefreshNormalHeader headerWithRefreshingTarget:self refreshingAction:@selector(doWebRequest)];
        [_header setTitle:@"下拉刷新加载更多" forState:MJRefreshStateIdle];
        [_header setTitle:@"松开刷新载更多" forState:MJRefreshStatePulling];
        [_header setTitle:@"数据加载中...." forState:MJRefreshStateRefreshing];
        [_header setTitle:@"没有更多数据...." forState:MJRefreshStateNoMoreData];
        _header.lastUpdatedTimeLabel.hidden = YES;
        _header.stateLabel.font = [UIFont systemFontOfSize:13];
        _header.stateLabel.textColor = Color().Auxiliary;
    }
    return _header;
}

- (void)viewDidLoad {
    [super viewDidLoad];
    
    
    //[self addNavigationSearchBar];
    self.navigationBar.separatorColor = [UIColor clearColor];
//    self.webProgess.hidden = YES;
    [self layoutSubControls];

}

//- (void)viewWillAppear:(BOOL)animated {
//    [super viewWillAppear:animated];
//
//    __weak typeof(self) weakSelf = self;
//    static dispatch_once_t onceToken;
//    dispatch_once(&onceToken, ^{
//        [weakSelf doWebRequest];
//    });
//}

- (void)addItemWithIconName:(NSString *)name leftItem:(BOOL)leftItem edgeInsets:(UIEdgeInsets)edgeInsets {
    CGFloat itemHeight = NAVI_HEIGHT - STATUSBAR_HEIGHT - 6;
    CGFloat iconSize = 22;
    
    UIView *bottomView = [[UIView alloc] init];
//    bottomView.backgroundColor = [UIColor redColor];
    bottomView.frame = CGRectMake(0, 0, 55, itemHeight);
    
    UIButton *button = [[UIButton alloc] init];
    button.hitTestEdgeInsets = UIEdgeInsetsMake(-20, -20, -20, -20);
    button.frame = CGRectMake((CGRectGetWidth(bottomView.frame) - iconSize) / 2, (CGRectGetHeight(bottomView.frame) - iconSize) / 2, iconSize, iconSize);
    [button setBackgroundImage:[UIImage imageNamed:name] forState:UIControlStateNormal];
    button.imageView.contentMode = UIViewContentModeScaleAspectFit;
    [bottomView addSubview:button];
    
    PCDBarButtonItem *item = [[PCDBarButtonItem alloc] initWithCustomView:bottomView];
    item.contentInsets = edgeInsets;
    if (leftItem) {
        self.navigationBar.leftBarButtonItem = item;
        [button addTarget:self action:@selector(leftBarButtonPressed) forControlEvents:UIControlEventTouchUpInside];
    } else {
        self.navigationBar.rightBarButtonItem = item;
        [button addTarget:self action:@selector(rightBarButtonPressed) forControlEvents:UIControlEventTouchUpInside];
    }
}

- (void)addNavigationSearchBar {
    self.searchImageView = [[UIImageView alloc] init];
    self.searchImageView.backgroundColor = [UIColor colorFormString:@"#f3f6f6"];
    self.searchImageView.layer.masksToBounds = YES;
    self.searchImageView.userInteractionEnabled = YES;
    [self.searchImageView addGestureRecognizer:[[UITapGestureRecognizer alloc] initWithTarget:self action:@selector(searchAction:)]];
    [self.navigationBar addSubview:self.searchImageView];

    self.leftIcon = [[UIImageView alloc] init];
    self.leftIcon.contentMode = UIViewContentModeScaleAspectFit;
    self.leftIcon.image = [UIImage imageNamed:@"searchIcon.png"];
    [self.searchImageView addSubview:self.leftIcon];
    
    self.rightIcon = [[UIButton alloc] init];
    self.rightIcon.hitTestEdgeInsets = UIEdgeInsetsMake(-20, -20, -20, -20);
    self.rightIcon.imageView.contentMode = UIViewContentModeScaleAspectFit;
    [self.rightIcon setImage:[UIImage imageNamed:@"service.png"] forState:UIControlStateNormal];
    [self.searchImageView addSubview:self.rightIcon];
    [self.rightIcon addTarget:self action:@selector(customerServiceFunc) forControlEvents:UIControlEventTouchUpInside];
    
    [self addItemWithIconName:@"message.png" leftItem:NO edgeInsets:UIEdgeInsetsZero];
    [self addItemWithIconName:@"scan.png" leftItem:YES edgeInsets:UIEdgeInsetsMake(0, -10, 0, 0)];
}

- (void)layoutSubControls {
    [self.searchImageView mas_makeConstraints:^(MASConstraintMaker *make) {
        make.top.mas_equalTo(self.navigationBar.mas_top).offset(STATUSBAR_HEIGHT + 6);
        make.bottom.mas_equalTo(self.navigationBar.mas_bottom).offset(-8);
        make.centerX.mas_equalTo(self.navigationBar.mas_centerX);
        make.width.mas_equalTo(Width - 55 * 2);
    }];
    [self.leftIcon mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_equalTo(self.searchImageView.mas_left).offset(10);
        make.width.height.mas_equalTo(20);
        make.centerY.mas_equalTo(self.searchImageView.mas_centerY);
    }];
    [self.rightIcon mas_makeConstraints:^(MASConstraintMaker *make) {
        make.right.mas_equalTo(self.searchImageView.mas_right).offset(-12);
        make.width.height.mas_equalTo(self.leftIcon);
        make.centerY.mas_equalTo(self.searchImageView.mas_centerY);
    }];
}

- (void)searchAction:(UIGestureRecognizer *)gesture {
    PCDContext *context = [[PCDContext alloc] init];
    context.viewController = self;
    
    
//    NSString *detailMessage=[dict objectForKey:@"SHARE_CONTENT"];
//
//    NSString *title=[dict objectForKey:@"SHARE_TITLE"];
//
//    NSString *imageSrc=[dict objectForKey:@"IMG_URL"];
//
//    NSString *url=[dict objectForKey:@"LINK_URL"];
//
//    NSString *type=[dict objectForKey:@"SHARE_TYPE"];
    NSArray *shareList = @[@{@"SHARE_CONTENT" : @"分享内容",@"SHARE_TITLE" : @"串串盈分享",@"IMG_URL" : @"https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1562218922113&di=1610d5dd7b710c2621c8edebca80fc0c&imgtype=0&src=http%3A%2F%2Fpic37.nipic.com%2F20140113%2F8800276_184927469000_2.png",@"LINK_URL" : @"https://mbd.baidu.com/newspage/data/landingsuper?context=%7B%22nid%22%3A%22news_9692634258155626504%22%7D&n_type=0&p_from=1",@"SHARE_TYPE" : @"22"},
                          @{@"SHARE_CONTENT" : @"分享内容1",@"SHARE_TITLE" : @"串串盈分享1",@"IMG_URL" : @"https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1562218922113&di=1610d5dd7b710c2621c8edebca80fc0c&imgtype=0&src=http%3A%2F%2Fpic37.nipic.com%2F20140113%2F8800276_184927469000_2.png",@"LINK_URL" : @"https://mbd.baidu.com/newspage/data/landingsuper?context=%7B%22nid%22%3A%22news_9692634258155626504%22%7D&n_type=0&p_from=1",@"SHARE_TYPE" : @"23"},
  @{@"SHARE_CONTENT" : @"分享内容1",@"SHARE_TITLE" : @"串串盈分享1",@"IMG_URL" : @"https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1562218922113&di=1610d5dd7b710c2621c8edebca80fc0c&imgtype=0&src=http%3A%2F%2Fpic37.nipic.com%2F20140113%2F8800276_184927469000_2.png",@"LINK_URL" : @"https://mbd.baidu.com/newspage/data/landingsuper?context=%7B%22nid%22%3A%22news_9692634258155626504%22%7D&n_type=0&p_from=1",@"SHARE_TYPE" : @"01"}];
    NSDictionary *dict = @{@"shareList" : shareList};
    [[[SharePagesH5Plugin alloc] init] handler:dict andContext:context ResponseCallback:^(id responseData) {
        
    }];
//    [JSLoginManager reloadRootViewControllers];
//    [JSLoginManager clientLoginWithTarget:self success:^(id  _Nonnull resultResponse, LoginSession * _Nonnull session) {
//
////        NSDictionary *expando = [PCDUtil IsIphoneX]?@{@"NSLayoutAttributeTop":@"88"}:@{@"NSLayoutAttributeTop":@"64"};
////        NSDictionary *param = @{@"url" : [PCDUtil getPublicServerURL:@"102/01/P10201.html"]};
////        JSBaseWebViewController *webVC = [PCDWServiceGet() createPCDViewController:param viewControllerClass:[JSBaseWebViewController class] contentViewClass:nil withExpando:expando];
//        [self.tabBarController.navigationController popViewControllerAnimated:YES];
//    } faild:^(NSString * _Nonnull MSG, LoginSession * _Nonnull session, id resultResponse) {
//
//    }];
//    JSSearchViewController *searchVC = [[JSSearchViewController alloc] init];
//    searchVC.hidesBottomBarWhenPushed = YES;
//    [self.tabBarController.navigationController pushViewController:searchVC animated:YES];
}

- (void)customerServiceFunc {
//#if TARGET_IPHONE_SIMULATOR
//#else
//    JSFaceRecordViewController *faceVC = [[JSFaceRecordViewController alloc] init];
//    faceVC.type = @"1";
//    faceVC.callBackHandle=^(NSDictionary *dictData) {};
//    faceVC.hidesBottomBarWhenPushed = YES;
//    [self.tabBarController.navigationController pushViewController:faceVC animated:YES];
//#endif
//    JSBiometryLoginViewController *vc = [[JSBiometryLoginViewController alloc] init];
//    vc.hidesBottomBarWhenPushed = YES;
//    [self.tabBarController.navigationController pushViewController:vc animated:YES];
}

- (void)leftBarButtonPressed {
    JSScanViewController *scanVC = [[JSScanViewController alloc] init];
    scanVC.hidesBottomBarWhenPushed = YES;
    [self.tabBarController.navigationController pushViewController:scanVC animated:YES];
}
#pragma mark - webView右边按钮
- (void)rightBarButtonPressed {
}
- (BOOL)webView:(UIWebView *)webView shouldStartLoadWithRequest:(NSURLRequest *)request navigationType:(UIWebViewNavigationType)navigationType {
    
    return YES;
}
- (void)webViewDidFinishLoad:(UIWebView *)webView {
    [self.bankWebView.scrollView.mj_header endRefreshing];
//    self.webProgess.progress = 1;
}
- (void)webViewDidStartLoad:(UIWebView *)webVie {
//    self.webProgess.progress = 0.3;
}

- (void)webView:(UIWebView *)webView didFailLoadWithError:(NSError *)error {
    NSLog(@"didFailLoadWithError");
    [self.bankWebView.scrollView.mj_header endRefreshing];
//    self.webProgess.progress = 0.0;
}

@end
