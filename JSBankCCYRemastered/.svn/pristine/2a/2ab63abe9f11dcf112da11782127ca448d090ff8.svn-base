//
//  ShareReceiptH5Plugin.m
//  PCDBank
//
//  Created by 王俣 on 2018/9/21.
//  Copyright © 2018年 yt. All rights reserved.
//

#import "ShareReceiptH5Plugin.h"
#import "PCShareModel.h"

@implementation ShareReceiptH5Plugin

- (void)handler:(id)data andContext:(PCDContext *)context{
    NSDictionary *dict = (NSDictionary *)data;
    NSString *type = dict[@"type"];
    NSArray *typeArr = [type componentsSeparatedByString:@","];
    NSString *callBack = dict[@"callback"];
    NSMutableArray *tmpArr = [NSMutableArray new];

    typeArr = @[@"PYQ"];
    
    for (NSString *t in typeArr) {
        
        if ([t isEqualToString:@"WX"]) {
            [tmpArr addObject:@(SSDKPlatformSubTypeWechatSession)];
        }
        if ([t isEqualToString:@"PYQ"]) {
            [tmpArr addObject:@(SSDKPlatformSubTypeWechatTimeline)];
        }
        if ([t isEqualToString:@"QQ"]) {
            [tmpArr addObject:@(SSDKPlatformSubTypeQQFriend)];
        }
        if ([t isEqualToString:@"WB"]) {
            [tmpArr addObject:@(SSDKPlatformTypeSinaWeibo)];
        }
        if ([t isEqualToString:@"DX"]) {
            [tmpArr addObject:@(SSDKPlatformTypeSMS)];
        }
        if ([t isEqualToString:@"YX"]) {
//            [tmpArr addObject:@(SSDKPlatformTypeMail)];
        }
    }
    
//    UIWebView *web =  self.bsContext.webView;
//
//    UIImage *shotcut = [self imageRepresentationWithWebView:web];
//
//    NSArray *images = shotcut ? @[shotcut] : @[];
    //分享
    
    NSString *ver = [ShareSDK sdkVersion];
    
    ver = [ver stringByReplacingOccurrencesOfString:@"." withString:@""];
    
    NSMutableDictionary *shareParams = [NSMutableDictionary dictionary];
    
    [shareParams SSDKSetupWeChatParamsByText:@"sdvsd" title:@"sdvsd" url:nil thumbImage:@"" image:@"" musicFileURL:nil extInfo:@"" fileData:@"" emoticonData:@"" sourceFileExtension:@"" sourceFileData:@"" type:SSDKContentTypeText forPlatformSubType:SSDKPlatformSubTypeWechatTimeline];
    
    //2、分享（可以弹出我们的分享菜单和编辑界面）
    
    if ([ver integerValue]<412) {
        
        [ShareSDK showShareActionSheet:nil //要显示菜单的视图, iPad版中此参数作为弹出菜单的参照视图，只有传这个才可以弹出我们的分享菜单，可以传分享的按钮对象或者自己创建小的view 对象，iPhone可以传nil不会影响
                                 items:tmpArr
                           shareParams:shareParams
                   onShareStateChanged:^(SSDKResponseState state, SSDKPlatformType platformType, NSDictionary *userData, SSDKContentEntity *contentEntity, NSError *error, BOOL end) {
                       
                       switch (state) {
                           case SSDKResponseStateSuccess:
                           {
                               evaluateJavaScriptOnMainThread_quotes(self, callBack, @"分享成功");
                               break;
                           }
                           case SSDKResponseStateFail:
                           {
                               evaluateJavaScriptOnMainThread_quotes(self, callBack, @"分享失败");
                               break;
                           }
                           default:
                               break;
                       }
                   }
         ];
        
    }else{
        
        [ShareSDK showShareActionSheet:nil customItems:tmpArr shareParams:shareParams sheetConfiguration:nil onStateChanged:^(SSDKResponseState state, SSDKPlatformType platformType, NSDictionary *userData, SSDKContentEntity *contentEntity, NSError *error, BOOL end) {
            NSLog(@"error : %@",error);
//            BOOL qqInstalled = [ShareSDK isClientInstalled:SSDKPlatformTypeQQ];
//            if (!qqInstalled) {
//
//                evaluateJavaScriptOnMainThread_quotes(self, callBack, @"qq未安装");
//
//                return ;
//            }
            switch (state) {
                case SSDKResponseStateSuccess:
                {
                    evaluateJavaScriptOnMainThread_quotes(self, callBack, @"分享成功");
                    break;
                }
                case SSDKResponseStateFail:
                {
                    evaluateJavaScriptOnMainThread_quotes(self, callBack, @"分享失败");
                    break;
                }
                default:
                    break;
            }
        }];
        
    }
    
}
- (UIImage *)imageRepresentationWithWebView:(UIWebView *)webView{
    CGFloat scale = [UIScreen mainScreen].scale;
    
    CGSize boundsSize = webView.bounds.size;
    CGFloat boundsWidth = boundsSize.width;
    CGFloat boundsHeight = boundsSize.height;
    
    CGSize contentSize = webView.scrollView.contentSize;
    CGFloat contentHeight = contentSize.height;
    
    CGPoint offset = webView.scrollView.contentOffset;
    
    [webView.scrollView setContentOffset:CGPointMake(0, 0)];
    
    NSMutableArray *images = [NSMutableArray array];
    while (contentHeight > 0) {
        UIGraphicsBeginImageContextWithOptions(boundsSize, NO, 0.0);
        [webView.layer renderInContext:UIGraphicsGetCurrentContext()];
        UIImage *image = UIGraphicsGetImageFromCurrentImageContext();
        UIGraphicsEndImageContext();
        [images addObject:image];
        
        CGFloat offsetY = webView.scrollView.contentOffset.y;
        [webView.scrollView setContentOffset:CGPointMake(0, offsetY + boundsHeight)];
        contentHeight -= boundsHeight;
    }
    
    [webView.scrollView setContentOffset:offset];
    
    CGSize imageSize = CGSizeMake(contentSize.width * scale,
                                  contentSize.height * scale);
    UIGraphicsBeginImageContext(imageSize);
    [images enumerateObjectsUsingBlock:^(UIImage *image, NSUInteger idx, BOOL *stop) {
        [image drawInRect:CGRectMake(0,
                                     scale * boundsHeight * idx,
                                     scale * boundsWidth,
                                     scale * boundsHeight)];
    }];
    UIImage *fullImage = UIGraphicsGetImageFromCurrentImageContext();
    UIGraphicsEndImageContext();
    UIImageWriteToSavedPhotosAlbum(fullImage, nil, nil, nil);
    return fullImage;
}

- (void)screenView:(UIView *)view {
    // 设置截图大小
    UIGraphicsBeginImageContextWithOptions(CGSizeMake(Width,view.frame.size.height), YES, 0);
    [view.layer renderInContext:UIGraphicsGetCurrentContext()];
    UIImage *viewImage = UIGraphicsGetImageFromCurrentImageContext();
    UIGraphicsEndImageContext();
    CGImageRef imageRef = viewImage.CGImage;
    UIImage *sendImage = [[UIImage alloc] initWithCGImage:imageRef];
    NSLog(@"sendImage==%@",sendImage);
    //保存图片到照片库 （iOS10 以上记得在info.plist添加相册访问权限，否则可能崩溃）
    UIImageWriteToSavedPhotosAlbum(sendImage, nil, nil, nil);
}

@end
