//
//  LoadProfilePicture.m
//  JSBankCCYRemastered
//
//  Created by Jack on 2019/7/25.
//  Copyright © 2019 Jack. All rights reserved.
//

#import "LoadProfilePicture.h"

@interface LoadProfilePicture ()<UINavigationControllerDelegate,UIImagePickerControllerDelegate, UIAlertViewDelegate>
@property (nonatomic, copy) NSString *callback;
@property (nonatomic, copy) NSString *uploadType;
@property (nonatomic, copy) NSString *reviewImageCallBack;

@end
@implementation LoadProfilePicture

- (void)handler:(id)data andContext:(PCDContext *)context ResponseCallback:(WVJBResponseCallback )responseCallback {
    JSBaseWebViewController *viewController = (JSBaseWebViewController *)context.viewController;

    NSDictionary *dict = (NSDictionary *)data;
    self.callback = [dict objectForKey:@"callback"];
    self.uploadType = [dict objectForKey:@"uploadType"];
    self.reviewImageCallBack = [dict objectForKey:@"reviewImageCallBack"];
    self.callback = self.callback.notNull ? self.callback : @"";
    self.uploadType = self.uploadType.notNull ? self.uploadType : @"1";

    if (@available(iOS 8.0, *)) {
        UIAlertController *alertController = [UIAlertController alertControllerWithTitle:@"选取一张图片" message:@"" preferredStyle:UIAlertControllerStyleActionSheet];
        
        UIAlertAction *photoAction = [UIAlertAction actionWithTitle:@"从相册选择" style:UIAlertActionStyleDefault handler:^(UIAlertAction * _Nonnull action) {
            [self pickImageWithType:UIImagePickerControllerSourceTypePhotoLibrary target:viewController];
        }];
        UIAlertAction *cameraAction = [UIAlertAction actionWithTitle:@"相机拍照选择" style:UIAlertActionStyleDefault handler:^(UIAlertAction * _Nonnull action) {
#if TARGET_IPHONE_SIMULATOR
            [JSDeftAlert showMessage:@"模拟器不支持拍照" afterDelay:2.5 completeHandle:nil];
#else
            [self pickImageWithType:UIImagePickerControllerSourceTypeCamera target:viewController];
#endif
        }];
        UIAlertAction *cancelAction = [UIAlertAction actionWithTitle:@"取消" style:UIAlertActionStyleCancel handler:^(UIAlertAction * _Nonnull action) {
            
        }];
        [alertController addAction:photoAction];
        [alertController addAction:cameraAction];
        [alertController addAction:cancelAction];
        [viewController presentViewController:alertController animated:YES completion:nil];
    }
}

- (void)pickImageWithType:(UIImagePickerControllerSourceType)type target:(UIViewController *)target {
    UIImagePickerController *imgPicker = [[UIImagePickerController alloc] init];
    imgPicker.sourceType = type;
    imgPicker.delegate = self;
    [target presentViewController:imgPicker animated:YES completion:nil];
}

- (void)imagePickerController:(UIImagePickerController *)picker didFinishPickingMediaWithInfo:(NSDictionary<NSString *,id> *)info {
    UIImage *image = info[UIImagePickerControllerOriginalImage];
    NSData *imageData=[image compressWithMaxLength:400000];

    NSString *base64String = imageData.base64EncodedString;
    if (base64String.notNull) {
        NSString *reviewImageString = [NSString stringWithFormat:@"data:image/jpeg;base64,%@",base64String];
        evaluateJavaScriptOnMainThread_quotes(self, self.reviewImageCallBack, reviewImageString);
        [self uploadProfileImage:base64String];
    }
    [picker dismissViewControllerAnimated:YES completion:nil];
}
- (void)imagePickerControllerDidCancel:(UIImagePickerController *)picker {
    [picker dismissViewControllerAnimated:YES completion:nil];
}

- (void)uploadProfileImage:(NSString *)base64 {
    [LoadIndicator showLoadingIndicatorWithText:@"正在上传..." shouldTap:NO];
    [ClientNetManager uploadProfileImageBase64:base64 uploadType:self.uploadType success:^(id resultResponse) {
        [JSDeftAlert showMessage:@"操作完成" afterDelay:1.6 completeHandle:nil];
        NSDictionary *dic = (NSDictionary *)resultResponse;
        NSString *imageName = [dic objectForKey:@"imgName"];
        evaluateJavaScriptOnMainThread_quotes(self, self.callback, imageName);
    } failure:^(NSString *MSG) {
        if (MSG.notNull) {
            [JSDeftAlert showMessage:MSG afterDelay:1.6 completeHandle:nil];
        }
    }];
}

@end
