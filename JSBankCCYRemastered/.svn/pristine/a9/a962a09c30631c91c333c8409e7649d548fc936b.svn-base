//
//  PCSettingViewController.m
//  PCKit
//
//  Created by wangyong on 16/5/6.
//  Copyright © 2016年 P&C Information. All rights reserved.
//

#import "PCDSettingViewController.h"

#define kIPSettingRecordKey @"PCDIpSettingRecordsString"

typedef void(^ConfigBlock)(BOOL show);
typedef void(^SaveUseGateWayFlagBlock)(void);

@interface PCDSettingViewController ()<UITableViewDataSource,UITableViewDelegate,UIActionSheetDelegate,UITextFieldDelegate>

@property(nonatomic,strong) UITableView *settingTableView;
@property(nonatomic,strong) UIView *headerView;
@property(nonatomic,strong) UITextField *txtService;
@property(nonatomic,strong) UITextField *txtResource;
@property(nonatomic,strong) UIButton *btnSave;

@property(nonatomic,strong)NSMutableArray *arrayOfRecord;
@property (nonatomic,copy) ConfigBlock configBlock;
@property (nonatomic,copy) SaveUseGateWayFlagBlock saveUseGateWayBlock;

@end

@implementation PCDSettingViewController

-(void)viewDidLoad{
    [super viewDidLoad];
    self.title =@"App设置";
    [self loadRecords];
    [self initContentView];
}

-(void)loadRecords{
    NSArray *array =[[NSUserDefaults standardUserDefaults] objectForKey:kIPSettingRecordKey];
    self.arrayOfRecord =[NSMutableArray arrayWithArray:array];
}

-(void)initContentView{
    if (self.settingTableView==nil) {
        self.settingTableView =[[UITableView alloc]initWithFrame:self.view.bounds style:UITableViewStyleGrouped];
        self.settingTableView.backgroundColor =[UIColor clearColor];
    }
    if (![self.settingTableView isDescendantOfView:self.view]) {
        [self.view addSubview:self.settingTableView];
        [self.view sendSubviewToBack:self.settingTableView];
    }
    self.settingTableView.dataSource =self;
    self.settingTableView.delegate =self;
    self.settingTableView.translatesAutoresizingMaskIntoConstraints =NO;
    
    NSDictionary *dict = NSDictionaryOfVariableBindings(_settingTableView);
    NSString *vf0 = @"|-0-[_settingTableView]-0-|";
    NSString *vf1 =[NSString stringWithFormat:@"V:|-%f-[_settingTableView]-0-|",self.navigationBarHeight];
    [self.view addConstraints:[NSLayoutConstraint constraintsWithVisualFormat:vf0 options:0 metrics:nil views:dict]];
    [self.view addConstraints:[NSLayoutConstraint constraintsWithVisualFormat:vf1 options:0 metrics:nil views:dict]];
    
    if (self.headerView==nil) {
        self.headerView =[[UIView alloc]initWithFrame:CGRectMake(0, 0, CGRectGetWidth(self.settingTableView.frame), 300)];
        self.headerView.backgroundColor =[UIColor whiteColor];
        
        UISegmentedControl *segmentControl =[[UISegmentedControl alloc]initWithItems:@[@"测试1",@"测试2",@"生产",@"当前地址"]];
        segmentControl.frame =CGRectMake(10, 10, CGRectGetWidth(self.settingTableView.frame)-20, 30);
        segmentControl.selectedSegmentIndex =3;
        [segmentControl addTarget:self action:@selector(segmentControlPressed:) forControlEvents:UIControlEventValueChanged];
        [self.headerView addSubview:segmentControl];
        
        UILabel *serviceLabel =[[UILabel alloc]initWithFrame:CGRectMake(10, 50, 100, 21)];
        serviceLabel.text =@"交易服务器:";
        [self.headerView addSubview:serviceLabel];
        
        self.txtService =[[UITextField alloc]initWithFrame:CGRectMake(10, 80, CGRectGetWidth(self.settingTableView.frame)-20, 30)];
        self.txtService.borderStyle =UITextBorderStyleRoundedRect;
        
        [self.headerView addSubview:self.txtService];
        
        UILabel *resourceLabel =[[UILabel alloc]initWithFrame:CGRectMake(10, 120, 100, 21)];
        resourceLabel.text =@"资源服务器:";
        [self.headerView addSubview:resourceLabel];
        
        self.txtResource =[[UITextField alloc]initWithFrame:CGRectMake(10, 150, CGRectGetWidth(self.settingTableView.frame)-20, 30)];
        self.txtResource.borderStyle =UITextBorderStyleRoundedRect;
//        self.txtResource.text =[PCSingleton shareInstance].resourceServiceAddress;
        [self.headerView addSubview:self.txtResource];
        
        self.txtService.text = [PCDUtil getServerURL:@""];
        self.txtResource.text = [PCDUtil getPublicServerURL:@""];
        
        //MARK: - 网关开关
        UILabel *gatewaty = [[UILabel alloc] initWithFrame:CGRectMake(10, 200, 80, 21)];
        gatewaty.text = @"网关开关";
        [self.headerView addSubview:gatewaty];
        
        UISwitch *switchBtn = [[UISwitch alloc] initWithFrame:CGRectMake(100, 195, 80, 21)];
        [switchBtn addTarget:self action:@selector(switchFunc:) forControlEvents:UIControlEventValueChanged];
        [self.headerView addSubview:switchBtn];
        
        UITextField *tf = [[UITextField alloc] initWithFrame:CGRectMake(270, 195, 70, 30)];
        UILabel *line = [[UILabel alloc] initWithFrame:CGRectMake(270, 225, 60, 1/[UIScreen mainScreen].scale)];
        line.backgroundColor = [UIColor blackColor];
        [self.headerView addSubview:line];
        [self.headerView addSubview:tf];
        UILabel *channelID = [[UILabel alloc] initWithFrame:CGRectMake(190, 195, 80, 21)];
        channelID.text = @"渠道ID:";
        [self.headerView addSubview:channelID];
        
        NSString *channelId = [PCDUtil channelId];
        
        tf.text = channelId;
        
        if ([PCDUtil useGateWay]) {
            
            tf.hidden = line.hidden = channelID.hidden = NO;
            [switchBtn setOn:YES];
        }else{
            
            tf.hidden = line.hidden = channelID.hidden = YES;
            [switchBtn setOn:NO];
        }
        
        self.configBlock = ^(BOOL show) {
            
            if (show) {//使用网关
                
                tf.hidden = NO;
                line.hidden = NO;
                channelID.hidden = NO;
                [PCDUtil setChannelId:tf.text];
            }else{
                
                tf.hidden = YES;
                line.hidden = YES;
                channelID.hidden = YES;
                [PCDUtil setChannelId:@""];
                
            }
            [PCDUtil setUseGateWayFlag:show];
        };
        
        self.saveUseGateWayBlock = ^{
            [PCDUtil setChannelId:tf.text];
        };
        
        self.btnSave =[UIButton buttonWithType:UIButtonTypeCustom];
        self.btnSave.frame=CGRectMake(CGRectGetWidth(self.settingTableView.frame)/2-50, 235, 100, 30);
        [self.btnSave setTitle:@"保 存" forState:UIControlStateNormal];
        [self.btnSave setTitleColor:[UIColor colorWithRed:0.000 green:0.357 blue:1.000 alpha:1.000] forState:UIControlStateNormal];
        [self.btnSave setTitleColor:[UIColor blueColor] forState:UIControlStateHighlighted];
        [self.btnSave addTarget:self action:@selector(saveButtonPressed:) forControlEvents:UIControlEventTouchUpInside];

        [self.headerView addSubview:self.btnSave];
    }
    self.settingTableView.tableHeaderView =self.headerView;
}

- (void)switchFunc:(UISwitch *)sender{
    
    if (sender.isOn) {
        
        self.configBlock(YES);
    }else{
        
        self.configBlock(NO);
    }
}

//MARK: - tavleview 代理方法

-(NSInteger)numberOfSectionsInTableView:(UITableView *)tableView{
    return 0;
}

- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section{
    return self.arrayOfRecord.count;
}

-(CGFloat)tableView:(UITableView *)tableView heightForHeaderInSection:(NSInteger)section{
    return 30.0f;
}

- (CGFloat)tableView:(UITableView *)tableView heightForRowAtIndexPath:(NSIndexPath *)indexPath{
    return 60.0f;
}

-(NSString *)tableView:(UITableView *)tableView titleForHeaderInSection:(NSInteger)section{
//    if (section==0 && self.arrayOfRecord.count>0) {
//        return @"IP设置记录";
//    }
    return @"";
}

- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath{
    
    static NSString *strCellIdentifier =@"PCSettingTableViewCellIdentifier";
    UITableViewCell *cell =[tableView dequeueReusableCellWithIdentifier:strCellIdentifier];
    
    if (cell ==nil) {
        cell =[[UITableViewCell alloc]initWithStyle:UITableViewCellStyleDefault reuseIdentifier:strCellIdentifier];
        cell.backgroundColor =[UIColor whiteColor];
        cell.selectionStyle =UITableViewCellSelectionStyleNone;
    }
    NSString *strCache =self.arrayOfRecord[indexPath.row];
//    strCache =[PCEncrypt decryptString:strCache withAESKey:@"2016_0509_0022_A"];
    NSArray *array =[strCache componentsSeparatedByString:@"[IP_SEP]"];
    if (array&&array.count>=2) {
        cell.textLabel.numberOfLines =2;
        cell.textLabel.adjustsFontSizeToFitWidth =YES;
        cell.textLabel.text =[NSString stringWithFormat:@"交易:%@\n资源:%@",array[0],array[1]];
    }
    return cell;
}

- (void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath{
    
    NSString *strCache =self.arrayOfRecord[indexPath.row];
//    strCache =[PCEncrypt decryptString:strCache withAESKey:@"2016_0509_0022_A"];
    NSArray *array =[strCache componentsSeparatedByString:@"[IP_SEP]"];
    if (array&&array.count>=2) {
        self.txtService.text =array[0];
        self.txtResource.text =array[1];
    }
}

-(void)scrollViewWillBeginDragging:(UIScrollView *)scrollView{
    
    [self.txtService resignFirstResponder];
    [self.txtResource resignFirstResponder];
}

//MARK: - segment切换

-(void)segmentControlPressed:(UISegmentedControl *)segmentedControl{
    
    NSString *strSeviceIP =@"";
    NSString *strResourceIP =@"";
    switch (segmentedControl.selectedSegmentIndex) {
        case 0:
        {
            strSeviceIP = [PCDUtil getObjectForKey:@"PCDebugServiceURLString"];
            strResourceIP = [PCDUtil getObjectForKey:@"PCDebugResoureURLString"];
        }
            break;
        case 1:
        {
            
            strSeviceIP = [PCDUtil getObjectForKey:@"PCPreReleaseServiceURLString"];
            strResourceIP = [PCDUtil getObjectForKey:@"PCPreReleaseResoureURLString"];
        }
            break;
        case 2:
        {
            strSeviceIP = [PCDUtil getObjectForKey:@"PCReleaseServiceURLString"];
            strResourceIP = [PCDUtil getObjectForKey:@"PCReleaseResoureURLString"];
        }
            break;
        case 3:
        {
            
            strSeviceIP = [PCDUtil getServerURL:@""];
            strResourceIP = [PCDUtil getPublicServerURL:@""];
            
        }
        default:
            return;
            break;
    }
    [PCDUtil setServerURL:strSeviceIP];
    [PCDUtil setResourceServiceAddress:strResourceIP];
    
    self.txtService.text = strSeviceIP;
    self.txtResource.text = strResourceIP;
}

//MARK: - 保存按钮点击 是将设置页面的信息保存到user default
-(void)saveButtonPressed:(UIButton *)btn{
    
    [PCDUtil showAlert:@"提示" message:@"保存成功!"];
    
    if (self.saveUseGateWayBlock) {
        
        self.saveUseGateWayBlock();
    }
    [PCDUtil setServerURL:self.txtService.text];
    [PCDUtil setResourceServiceAddress:self.txtResource.text];
}

@end
