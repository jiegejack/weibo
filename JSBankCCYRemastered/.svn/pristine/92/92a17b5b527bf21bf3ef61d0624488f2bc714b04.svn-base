//
//  JSCountDownView.m
//  JSBankCCYRemastered
//
//  Created by Jack on 2019/4/17.
//  Copyright © 2019 Jack. All rights reserved.
//

#import "JSCountDownView.h"

@interface JSCountDownView ()
@property(nonatomic,strong)NSTimer *timer;
@property(nonatomic,copy)NSString *normalTitle;
@property(nonatomic,strong)UIColor *normalColor;
@property(nonatomic,assign)CodeState stat;
@property(nonatomic,assign)NSInteger totalTime;

@end
@implementation JSCountDownView

- (id)init {
    if (self = [super init]) {
        self.stat = CodeStateNotSend;
        self.time = 60;
        self.color = [UIColor groupTableViewBackgroundColor];
        [self setTitleColor:[UIColor whiteColor] forState:UIControlStateNormal];
        self.titleLabel.font = [UIFont systemFontOfSize:13];
//        [self addTarget:self action:@selector(actionClick) forControlEvents:UIControlEventTouchUpInside];
    }
    return self;
}

+ (void)invalidTimer {
    [[[self alloc] init] stopTimer];
}

- (void)stopTimer {
    if (self.timer && [self.timer isValid]) {
        [self.timer invalidate];
        self.timer = nil;
    }
}

- (CodeState)codeState {
    
    return self.stat;
}

- (void)addTimer {
    if(!self.timer) {
        self.timer = [NSTimer timerWithTimeInterval:1.0f target:self selector:@selector(timerTrack) userInfo:nil repeats:YES];
        [[NSRunLoop currentRunLoop] addTimer:self.timer forMode:NSRunLoopCommonModes];
    }
}

//- (void)actionClick {
//    self.stat = CodeStateValid;
//    self.userInteractionEnabled = NO;
//    self.normalColor = self.backgroundColor;
//    self.normalTitle = self.titleLabel.text;
//    self.totalTime = self.time;
//
//    __weak typeof(self) weakSelf = self;
//    dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(1.0 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
//        weakSelf.backgroundColor = weakSelf.color ? self.color : weakSelf.backgroundColor;
//    });
//    [self addTimer];
//}

+ (void)startCounting {
    JSCountDownView *countDownView = [[self alloc] init];
    countDownView.stat = CodeStateValid;
    countDownView.userInteractionEnabled = NO;
    countDownView.normalColor = countDownView.backgroundColor;
    countDownView.normalTitle = countDownView.titleLabel.text;
    countDownView.totalTime = countDownView.time;
    countDownView.backgroundColor = countDownView.color ? countDownView.color : countDownView.backgroundColor;

    [countDownView addTimer];
}

- (void)timerTrack {
    if (self.time) {
        self.time -= 1;
        [self setTitle:[NSString stringWithFormat:@"  %ld%@  ",self.time, self.tagString.notNull ? self.tagString : @"秒"] forState:UIControlStateNormal];
    }
    
    if (!self.time && self.timer) {
        [self stopTimer];
        self.time = self.totalTime;
        self.stat = CodeStateInvalid;
        self.userInteractionEnabled = YES;
        self.backgroundColor = self.normalColor;
        [self setTitle:self.tipString.notNull ? self.tipString : self.normalTitle forState:UIControlStateNormal];
    }
}

@end
