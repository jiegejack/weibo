//
//  NBLogin.m
//  PCDBank
//
//  Created by 王俣 on 2018/8/22.
//  Copyright © 2018年 yt. All rights reserved.
//

#import "PCDLogin.h"

@implementation PCDLogin

- (void)handler:(id)data andContext:(PCDContext *)context ResponseCallback:(WVJBResponseCallback )responseCallback {
    JSBaseWebViewController *webV = (JSBaseWebViewController *)context.viewController;
    NSDictionary *dict = (NSDictionary *)data;
    NSString *callback = [dict objectForKey:@"callback"];
    NSString *backurl = [dict objectForKey:@"backUrl"];

    [JSLoginManager clientLoginSuccess:^(id  _Nonnull resultResponse, LoginSession * _Nonnull session) {
        [webV.tabBarController.navigationController popViewControllerAnimated:NO];
        [JSLoginManager reloadCurrentPage];
        if (callback.notNull) {
            if ([callback isEqualToString:@"shop"]) {
                [self fetchShopDataWithSubUrl:backurl];
            } else {
                evaluateJavaScriptOnMainThread(self, callback, @"");
            }
        }
//        evaluateJavaScriptOnMainThread(self, @"login.loginCallback()", @"");
    } faild:nil];
}

- (void)fetchShopDataWithSubUrl:(NSString *)subUrl {
    [LoadIndicator showLoadingIndicatorWithText:@"请稍后..." shouldTap:NO];
    [ClientNetManager fetchShopDataSuccess:^(id resultResponse, ShopModel *shopModel) {
        NSString *fullUrl = [NSString stringWithFormat:@"%@&authdata=%@&signdata=%@", subUrl, shopModel.confirmTransferDataSTR, shopModel.submitTransferDataSTR];
        [JSBaseWebViewController goWebViewWithUrl:fullUrl];
    } failure:^(NSString *MSG, ShopModel *shopModel) {
        
    }];
}

@end
