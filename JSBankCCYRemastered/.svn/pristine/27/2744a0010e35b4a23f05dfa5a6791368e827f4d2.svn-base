//
//  JSBaseWebViewController.m
//  JSBankCCYRemastered
//
//  Created by Jack on 2019/4/12.
//  Copyright © 2019 Jack. All rights reserved.
//

#import "JSBaseWebViewController.h"

@interface JSBaseWebViewController ()
@property (nonatomic,retain) UILabel *errorLabel;
@property (nonatomic,assign) BOOL shouldObserve;
@property (nonatomic,assign) BOOL isThirdPartPage;

@end

@implementation JSBaseWebViewController

- (void)setHiddenNaviBar:(BOOL)hiddenNaviBar {
    _hiddenNaviBar = hiddenNaviBar;
    
    self.navigationBar.alpha = !hiddenNaviBar;
    
    [self.bankWebView mas_remakeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_equalTo(self.view.mas_left);
        make.right.mas_equalTo(self.view.mas_right);
        make.bottom.mas_equalTo(self.view.mas_bottom);
        make.top.mas_equalTo(self.view.mas_top).offset(hiddenNaviBar ? STATUSBAR_HEIGHT : self.navigationBarHeight);
    }];
    
}

- (void)viewDidLoad {
    [super viewDidLoad];
    
    self.view.backgroundColor = [UIColor whiteColor];
    self.navigationBar.separatorColor = [UIColor whiteColor];
    self.navigationBar.backgroundColor = [UIColor whiteColor];
}

- (WebViewProgress *)webProgess {
    if (!_webProgess) {
        CGFloat progressHeight = 3;
        _webProgess = [[WebViewProgress alloc] init];
        _webProgess.frame = CGRectMake(0, self.navigationBarHeight - progressHeight, Width, progressHeight);
        _webProgess.strokColor = [UIColor blueColor];
        _webProgess.progressWidth = 2.1;
        [self.navigationBar addSubview:_webProgess];
    }
    return _webProgess;
}

#pragma mark - webView返回按钮
- (void)backBarButtonPressed {}

- (void)viewWillLayoutSubviews {
    [super viewWillLayoutSubviews];
    
    self.bankWebView.backgroundColor = [UIColor whiteColor];
}

- (void)doWebRequest {
    NSURL *url =[NSURL URLWithString:[self handleRequestUrl]];
    NSURLRequest *request = [[NSURLRequest alloc] initWithURL:url cachePolicy:NSURLRequestReloadIgnoringLocalCacheData timeoutInterval:30.0f];
    [self.bankWebView loadRequest:request];
}

- (NSString *)handleRequestUrl {
    NSString *requestUrl = ([self.requestUrl hasPrefix:@"http://"] || [self.requestUrl hasPrefix:@"https://"]) ? self.requestUrl : [PCDUtil getServerURL:self.requestUrl];

    return requestUrl;
}

- (UIWebView *)bankWebView {
    if (!_bankWebView) {
        for (UIView *subView in [self.view subviews]) {
            if ([subView isKindOfClass:[UIWebView class]]) {
                _bankWebView = (UIWebView *)subView;
            }
        }
    }
    return _bankWebView;
}

- (void)fetchWebViewTitle {
    if (self.isThirdPartPage) {
        NSUInteger maxLenth = 12;
        if (!self.title.notNull) {
            NSString *title = [self.bankWebView stringByEvaluatingJavaScriptFromString:@"document.title"];
            if (title.length < maxLenth) {
                self.title = title;
            } else {
                self.title = [NSString stringWithFormat:@"%@...",[title substringToIndex:maxLenth]];
            }
        }
    }
    [self.bankWebView stringByEvaluatingJavaScriptFromString:@"document.documentElement.style.webkitUserSelect='none';"];
}

- (void)webViewDidFinishLoad:(UIWebView *)webView {
    [self fetchWebViewTitle];
    [self.bankWebView.scrollView.mj_header endRefreshing];
    self.webProgess.progress = 1;
}
- (void)webViewDidStartLoad:(UIWebView *)webVie {
    self.webProgess.progress = 0.3;
}

- (void)webView:(UIWebView *)webView didFailLoadWithError:(NSError *)error {
    NSLog(@"didFailLoadWithError");
    [self.bankWebView.scrollView.mj_header endRefreshing];
    self.webProgess.progress = 0.0;
}

@end
