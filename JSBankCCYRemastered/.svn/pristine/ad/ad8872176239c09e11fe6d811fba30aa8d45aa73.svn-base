//
//  JSScanViewController.m
//  JSBankCCYRemastered
//
//  Created by Jack on 2019/5/5.
//  Copyright © 2019 Jack. All rights reserved.
//

#import "JSScanViewController.h"
#import <PCDQRCode/PCDQRCode.h>
#import <objc/runtime.h>

@interface JSScanViewController () <PCDScanViewDelegate>

@property(nonatomic,strong) PCDScanView *scanView;

@property(nonatomic,strong) PCDScanAnimationView *animationView;

@property(nonatomic,weak) UILabel *lbResult;

@end

@implementation JSScanViewController

- (void)viewDidLoad {
    [super viewDidLoad];
    
    self.title = @"扫一扫";
    self.navigationBar.backgroundColor =[UIColor clearColor];
    self.navigationBar.separatorColor =[[UIColor whiteColor] colorWithAlphaComponent:0.0];
    
    

    self.scanView = [[PCDScanView alloc] init];
    self.scanView.frame = CGRectMake(0, 0, Width, Height);
    [self.view insertSubview:self.scanView atIndex:0];
    
    self.animationView = [[PCDScanAnimationView alloc] init];
    [self.scanView addSubview:self.animationView];
    
    self.animationView.scanBox = @[[UIImage imageNamed:@"scan_1.png"],
                                   [UIImage imageNamed:@"scan_2.png"],
                                   [UIImage imageNamed:@"scan_3.png"],
                                   [UIImage imageNamed:@"scan_4.png"]];

    self.animationView.scanLine  = [UIImage imageNamed:@"scan_net.png"];
    self.animationView.isCoherent = NO;
    
    [self performSelector:@selector(setScanRect) withObject:nil afterDelay:0];
}

//设置扫描区域
-(void)setScanRect{
    //布局完成时，设置扫描区域
    CGFloat width =CGRectGetWidth(self.view.frame)*0.8;
    self.animationView.scanRect = CGRectMake(CGRectGetWidth(self.view.frame)*0.1, CGRectGetHeight(self.view.frame)*0.25, width, width);
}

-(void)viewWillAppear:(BOOL)animated{
    [super viewWillAppear:animated];
#if !TARGET_OS_SIMULATOR
    [self.scanView startRuning];
#endif
    [self.animationView startAnimation];
}

-(void)viewDidDisappear:(BOOL)animated{
    [super viewDidDisappear:animated];
#if !TARGET_OS_SIMULATOR
    [self.scanView stopRuning];
#endif
    [self.animationView stopAnimation];
}

- (void)viewWillLayoutSubviews {
    
    [super viewWillLayoutSubviews];
    
    if (![PCDevice iOS8Later]) {
        //解决iOS8以下自动布局和layoutSubviews的bug
        IMP imp =class_getMethodImplementation([self.animationView class], @selector(layoutSubviews));
        void (*callSuper)(id, SEL) = (void *)imp;
        callSuper(self.animationView,@selector(layoutSubviews));
    }
}

#pragma mark -PCDScanViewDelegate
- (void)scanView:(PCDScanView *)scanView didFailScanWithError:(NSError *)error {
    //scan error: 999 means CameraUnavailable, 888 means GetDataFailed.
    self.lbResult.text =[NSString stringWithFormat:@"%@:%ld",error.domain,(long)error.code];
    if (error.code==888) {
        [self.scanView performSelector:@selector(startRuning) withObject:nil afterDelay:1];
    }
}

- (void)scanView:(PCDScanView *)scanView didFinishScan:(NSString *)resultString {
//    self.lbResult.text =resultString;
    [self.scanView stopRuning];
    [self.animationView stopAnimation];
    [self goWebViewWithUrl:resultString];
//    [self.scanView performSelector:@selector(startRuning) withObject:nil afterDelay:1];
}

- (void)goWebViewWithUrl:(NSString *)url {
    if (!url.notNull) {
        return;
    }
    if (![url hasPrefix:@"https://"] && ![url hasPrefix:@"http://"]) {
        url = [PCDUtil getPublicServerURL:url];
    }
    NSDictionary *param = @{@"url" : url};
    NSDictionary *expando = [PCDUtil IsIphoneX]?@{@"NSLayoutAttributeTop":@"88"}:@{@"NSLayoutAttributeTop":@"64"};
    
    JSBaseWebViewController *webVC = [PCDWServiceGet() createPCDViewController:param viewControllerClass:[JSBaseWebViewController class] contentViewClass:nil withExpando:expando];
    UIWindow *window = [UIApplication sharedApplication].delegate.window;
    UINavigationController *navi = (UINavigationController *)window.rootViewController;
    [navi pushViewController:webVC animated:YES];
}

@end
