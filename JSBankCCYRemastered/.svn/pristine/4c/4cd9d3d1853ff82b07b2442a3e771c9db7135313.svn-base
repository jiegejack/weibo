//
//  PickImage.m
//  JSBankCCYRemastered
//
//  Created by Jack on 2019/6/6.
//  Copyright © 2019 Jack. All rights reserved.
//

#import "PickImage.h"
#import "JSHomeViewController.h"

@interface PickImage ()<UINavigationControllerDelegate,UIImagePickerControllerDelegate, UIAlertViewDelegate>
@property (nonatomic, strong) JSBaseWebViewController *viewController;
@property (nonatomic, copy) NSString *callback;

@end

@implementation PickImage

- (void)handler:(id)data andContext:(PCDContext *)context ResponseCallback:(WVJBResponseCallback )responseCallback {
    self.viewController = (JSBaseWebViewController *)context.viewController;
    NSDictionary *dict = (NSDictionary *)data;
    if (!dict.notNull) {return;}
    self.callback = [dict objectForKey:@"callback"];

    if (@available(iOS 8.0, *)) {
        UIAlertController *alertController = [UIAlertController alertControllerWithTitle:@"选取一张图片" message:@"" preferredStyle:UIAlertControllerStyleActionSheet];

        UIAlertAction *photoAction = [UIAlertAction actionWithTitle:@"从相册选择" style:UIAlertActionStyleDefault handler:^(UIAlertAction * _Nonnull action) {
            [self pickImageWithType:UIImagePickerControllerSourceTypePhotoLibrary];
        }];
        UIAlertAction *cameraAction = [UIAlertAction actionWithTitle:@"相机拍照选择" style:UIAlertActionStyleDefault handler:^(UIAlertAction * _Nonnull action) {
            #if TARGET_IPHONE_SIMULATOR
            [JSDeftAlert showMessage:@"模拟器不支持拍照" afterDelay:2.5 completeHandle:nil];
            #else
            [self pickImageWithType:UIImagePickerControllerSourceTypeCamera];
            #endif
        }];
        UIAlertAction *cancelAction = [UIAlertAction actionWithTitle:@"取消" style:UIAlertActionStyleDefault handler:^(UIAlertAction * _Nonnull action) {
            
        }];
        
//        NSMutableAttributedString *titleAtt = [[NSMutableAttributedString alloc] initWithString:@"取消"];
////        [titleAtt addAttribute:NSFontAttributeName value:[UIFont systemFontOfSize:16] range:NSMakeRange(0, 2)];
//        [titleAtt addAttribute:NSForegroundColorAttributeName value:[UIColor redColor] range:NSMakeRange(0, 2)];
//        [alertController setValue:titleAtt forKey:@"_titleTextColor"];
        
        [alertController addAction:photoAction];
        [alertController addAction:cameraAction];
        [alertController addAction:cancelAction];
        [self.viewController presentViewController:alertController animated:YES completion:nil];
    } else {
        // Fallback on earlier versions
    }
}

- (void)pickImageWithType:(UIImagePickerControllerSourceType)type {
    UIImagePickerController *imgPicker = [[UIImagePickerController alloc] init];
    imgPicker.sourceType = type;
    imgPicker.delegate = self;
    [self.viewController presentViewController:imgPicker animated:YES completion:nil];
}

- (void)imagePickerController:(UIImagePickerController *)picker didFinishPickingMediaWithInfo:(NSDictionary<NSString *,id> *)info
{
    UIImage *image = info[UIImagePickerControllerOriginalImage];
    NSData *imageData = UIImagePNGRepresentation(image);
    NSString *base64String = imageData.base64EncodedString;
    if (base64String.notNull) {
        evaluateJavaScriptOnMainThread_quotes(self, self.callback, base64String);
    }
    [self.viewController dismissViewControllerAnimated:YES completion:nil];
}
- (void)imagePickerControllerDidCancel:(UIImagePickerController *)picker {
    [self.viewController dismissViewControllerAnimated:YES completion:nil];
}

@end
