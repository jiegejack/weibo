//
//  JSLoginManager.m
//  JSBankCCYRemastered
//
//  Created by Jack on 2019/5/6.
//  Copyright © 2019 Jack. All rights reserved.
//

#import "JSLoginManager.h"
#import "JSBiometryLoginViewController.h"
#import "JSLoginViewController.h"
#import "TouchIDManager.h"
#import "JSSettingPasswordViewController.h"
#import "RequestConfig.h"
#import "JSFaceRecordViewController.h"

@implementation JSLoginManager

static NSDictionary     *_loginParam;
static LoginType         _type;
static UIViewController *_target;
static RequestConfig    *_config;
static void(^_success)(id resultResponse, id resultModel);
static void(^_faild)(NSError *error, LoginSession *session);

+ (void)initialize {
    _config = [[RequestConfig alloc] init];
}

+ (BOOL)clientIsLogin {
    NSInteger status = [JSSharedInstance sharedInstance].loginSession.STATUS.integerValue;
    
    return status ? YES : NO;
}

+ (void)logoutClient {
    if ([JSSharedInstance sharedInstance].loginSession.STATUS.integerValue == 1) {
        [JSSharedInstance sharedInstance].loginSession = nil;
//        [PNCMBankGlobal sharedData].openid=nil;
//        [PNCMBankGlobal sharedData].openURL=nil;
//        [PNCMBankGlobal sharedData].headImageURL=nil;
        [self refreshRootViewControllers];
    }
}

+ (void)refreshRootViewControllers {
    UIWindow *window= [[[UIApplication sharedApplication] delegate] window];
    if (window.rootViewController) {
        for (UINavigationController *nav in [JSSharedInstance sharedInstance].viewControllers) {
            if ([nav.viewControllers.firstObject isKindOfClass:[JSRootWebViewController class]]) {
                JSRootWebViewController *rootVC=(JSRootWebViewController *)nav.viewControllers.firstObject;
                [rootVC doWebRequest];
            }
        }
    }
}

+ (void)indexToHomePage:(NSInteger)page {
    UIWindow *window = [UIApplication sharedApplication].delegate.window;
    UINavigationController *navi = (UINavigationController *)window.rootViewController;
    [navi popToRootViewControllerAnimated:NO];
    PCDTabBarController *tabBarController = (PCDTabBarController *)navi.viewControllers.lastObject;
    tabBarController.selectedIndex = page;
}

+ (void)clientLoginWithTarget:(UIViewController *)target
                      success:(nullable void(^)(id resultResponse, LoginSession *session))success
                        faild:(nullable void(^)(NSError *error, LoginSession *session))faild {
    
    if ([TouchIDManager biometryType] != DJBiometryTypeNotSupport) {
        [self biometryLoginWithTarget:target loginSuccess:success loginFaild:faild];
    } else {
        [self regularLoginWithTarget:target loginSuccess:success loginFaild:faild];
    }
}

+ (void)regularLoginWithTarget:(UIViewController *)target
                  loginSuccess:(void(^)(id resultResponse, LoginSession *session))loginSuccess
                    loginFaild:(void(^)(NSError *error, LoginSession *session))loginFaild {

    JSLoginViewController *vc = [[JSLoginViewController alloc] initWithSuccessBlock:^(id resultResponse, LoginSession *session) {
        if (loginSuccess) {
            loginSuccess(resultResponse, session);return;
        }
        [target.tabBarController.navigationController popViewControllerAnimated:NO];
    } faildBlock:^(NSError *error, LoginSession *session) {
        if (loginFaild) {
            loginFaild(error, session);
        }
    }];
    vc.hidesBottomBarWhenPushed = YES;
    [target.tabBarController.navigationController pushViewController:vc animated:YES];
}

+ (void)biometryLoginWithTarget:(UIViewController *)target
                   loginSuccess:(void(^)(id resultResponse, LoginSession *session))loginSuccess
                     loginFaild:(void(^)(NSError *error, LoginSession *session))loginFaild {
    
    JSBiometryLoginViewController *vc = [[JSBiometryLoginViewController alloc] initWithSuccessBlock:^(id resultResponse, LoginSession *session) {
        if (loginSuccess) {
            loginSuccess(resultResponse, session);return;
        }
        [target.tabBarController.navigationController popViewControllerAnimated:NO];
    } faildBlock:^(NSError *error, LoginSession *session) {
        if (loginFaild) {
            loginFaild(error, session);
        }
    }];
    vc.hidesBottomBarWhenPushed = YES;
    [target.tabBarController.navigationController pushViewController:vc animated:YES];
}

+ (void)loginWithLoginType:(LoginType)type
                loginParam:(NSDictionary *)loginParam
                    target:(nullable UIViewController *)target
                   success:(nullable void(^)(id resultResponse, LoginSession *session))success
                     faild:(nullable void(^)(NSError *error, LoginSession *session))faild {

    if (type != LoginTypeBiometry && !loginParam.notNull) {return;}

    _loginParam = loginParam;
    _target     = target;
    _type       = type;
    _success = success;
    _faild = faild;
    
    __weak typeof(self) weakSelf = self;
    [ClientNetManager fetchLoginDataWithParam:[self setLoginParamWithType:type]
                                  RequestPath:[self loginPathWithType:type]
                                      success:^(id resultResponse, id resultModel) {
                                          
        LoginSession *session = (LoginSession *)resultModel;
        if (!session) {return;}
        [JSSharedInstance sharedInstance].loginSession = session;
        
        NSString *msg = @"";
        if (session.STATUS.integerValue == 1) {
            msg = type == LoginTypeRegister ? @"注册成功" : @"登录成功";
            [self refreshRootViewControllers];
            if (success) {
                success(resultResponse, session);
            }
        } else {
            if (type != LoginTypeRegister) {
                NSString *status = session.STATUS;
                
                if ([status isEqualToString:@"FQZ02"] || //加强认证
                    [status isEqualToString:@"FQZ04"]) { //视频认证
                    
                    [weakSelf showAuthenticationWithFlag:status];
                } else {
                    msg = session.MSG;
                }
            } else {
                msg = session.MSG;
            }
            if (faild) {
                faild(nil, session);
            }
        }
        [weakSelf loginFinishedMsg:msg loginType:type];
    } failure:^(NSError *error, LoginSession *session) {
        if (faild) {
            faild(error, session);
        }
    }];
}

+ (void)loginFinishedMsg:(NSString *)msg loginType:(LoginType)type {
    if (msg.notNull) {
        __weak typeof(self) weakSelf = self;
        [JSDeftAlert showMessage:msg afterDelay:1.5 completeHandle:^{
            if (type == LoginTypeRegister) {
                [JSDeftAlert showAlert:@"请设置登录密码" doneTitle:@"确定" cancelTitle:nil doneHandle:^{
                    [weakSelf gotoSettingPwd];
                } cancelHandle:nil];
            }
        }];
    }
}

+ (void)showAuthenticationWithFlag:(NSString *)flag {
    __weak typeof(self) weakSelf = self;
    UIWindow *window = [UIApplication sharedApplication].delegate.window;
    UIViewController *vc = window.rootViewController;
    AlertExtension *alert = [[[AlertExtension alloc] init] alertWithTitle:@"温馨提示"
                                                                  message:@"为保证您的账户安全，请选择验证方式。"
                                                                   target:vc];
    alert.titleFont = [UIFont boldSystemFontOfSize:17];
    alert.titleColor = [UIColor blackColor];
    
    alert.messageFont = [UIFont systemFontOfSize:15];
    alert.messageColor = [UIColor blackColor];
    
    alert.cancelButtonTitle = @"取消";
    alert.otherButtonTitle = @"去认证";
    alert.otherBlock = ^{
        if ([flag isEqualToString:@"FQZ04"]) {
            UIWindow *window = [UIApplication sharedApplication].delegate.window;
            UINavigationController *navi = (UINavigationController *)window.rootViewController;
            
            [navi popViewControllerAnimated:NO];
            
            JSFaceRecordViewController *faceVC=[[JSFaceRecordViewController alloc]init];
            faceVC.type = @"03";
            faceVC.loginParam = _loginParam;
            faceVC.loginType = _type;
            [navi pushViewController:faceVC animated:YES];
        }
        if ([flag isEqualToString:@"FQZ02"]) {
            [weakSelf excuteAuthenticationWithFlag:flag];
        }
    };
    [alert showAlert];
}

+ (void)excuteAuthenticationWithFlag:(NSString *)flag {
    NSString *mobileNo = [_loginParam objectForKey:@"mobileNo"];
    mobileNo = mobileNo.notNull ? mobileNo : @"";
    
    NSString *url = [NSString stringWithFormat:@"http://66.0.245.212:8081/ares-web-h5/page/client.html#page/PP01/PP0105/PP0105.html?validateType=msg&mobileNo=%@&smsType=login", mobileNo];
    
    NSDictionary *param = @{@"url" : url};
    NSDictionary *expando = [PCDUtil IsIphoneX]?@{@"NSLayoutAttributeTop":@"88"}:@{@"NSLayoutAttributeTop":@"64"};

    JSBaseWebViewController *webVC = [PCDWServiceGet() createPCDViewController:param viewControllerClass:[JSBaseWebViewController class] contentViewClass:nil withExpando:expando];
    UIWindow *window = [UIApplication sharedApplication].delegate.window;
    UINavigationController *navi = (UINavigationController *)window.rootViewController;
    [navi pushViewController:webVC animated:YES];
}

+ (void)gotoSettingPwd {
    UIWindow *window = [UIApplication sharedApplication].delegate.window;
    UINavigationController *navi = (UINavigationController *)window.rootViewController;
    JSSettingPasswordViewController *setVC = [[JSSettingPasswordViewController alloc] init];
    [navi pushViewController:setVC animated:YES];
}

+ (NSMutableDictionary *)setLoginParamWithType:(LoginType)type {
    NSMutableDictionary *param = [NSMutableDictionary dictionary];
    NSString *loginType      = @"";
    NSString *isPassword     = @"";
    NSString *OPER_TYPE      = @"";
    NSString *loginflag      = @"";
    NSString *Recommend      = @"";
    NSString *CustemployeNo  = @"";
    NSString *LoginPassword  = @"";
    NSString *regflag        = @"";
    NSString *PhoneNo        = [self setPhoneNo];
    NSString *SMSCode        = [self setSMSCode];

    switch (type) {
        case LoginTypePassword:
            SMSCode = @"";
            loginType  = @"200";
            isPassword = @"1";
            OPER_TYPE  = @"pwd";
            loginflag  = @"2";
            LoginPassword  = [self setLoginPassword];
            break;
        case LoginTypeBiometry:
            SMSCode   = @"";
            PhoneNo   = @"";
            CustemployeNo  = [self setCustemployeNo];
            loginType = @"206";
            OPER_TYPE = @"finger";
            loginflag = @"3";
            break;
        case LoginTypeCode:
            loginType = @"201";
            OPER_TYPE = @"msg";
            loginflag = @"2";
            break;
        case LoginTypeRegister:
            Recommend = [self setRecommend];
            loginType = @"207";
            regflag   = @"1";
            OPER_TYPE = @"finger";
            loginflag = @"3";
            break;
        default:
            break;
    }
    [param setObject:loginType     forKey:@"loginType"];
    [param setObject:isPassword    forKey:@"isPassword"];
    [param setObject:OPER_TYPE     forKey:@"OPER_TYPE"];
    [param setObject:loginflag     forKey:@"loginflag"];
    [param setObject:PhoneNo       forKey:@"mobileNo"];
    [param setObject:LoginPassword forKey:@"loginPassword"];
    [param setObject:SMSCode       forKey:@"code"];
    [param setObject:Recommend     forKey:@"recommend"];
    [param setObject:CustemployeNo forKey:@"custemployeNo"];
    [param setObject:regflag       forKey:@"regflag"];
    [param setObject:@"iOS"        forKey:@"LoginChannel"];
    [param setObject:@"0006"       forKey:@"developChannel"];

    return param;
}
+ (NSString *)setSMSCode {
    NSString *code = [_loginParam objectForKey:@"code"];
    code = code.notNull ? code : @"";
    
    return code;
}
+ (NSString *)setLoginPassword {
    NSString *pwd = [_loginParam objectForKey:@"loginPassword"];
    pwd = pwd.notNull ? pwd : @"";
    
    return pwd;
}
+ (NSString *)setCustemployeNo {
    NSString *custemployeNo = [JSSharedInstance sharedInstance].loginSession.custemployeNo;
    custemployeNo = custemployeNo.notNull ? custemployeNo : @"";
    
    return custemployeNo;
}
+ (NSString *)setRecommend {
    NSString *recommend = [_loginParam objectForKey:@"recommend"];
    recommend = recommend.notNull ? recommend : @"";

    return recommend;
}
+ (NSString *)setPhoneNo {
    NSString *phoneNo = [_loginParam objectForKey:@"mobileNo"];
    phoneNo = phoneNo.notNull ? phoneNo : @"";
    
    return phoneNo;
}

+ (NSString *)loginPathWithType:(LoginType)type {
   switch (type) {
        case LoginTypePassword:
            return _config.loginPassword;
            break;
        case LoginTypeBiometry:
            return _config.biometryLogin;
            break;
        case LoginTypeCode:
            return _config.SMSCodeLogin;
            break;
        case LoginTypeRegister:
            return _config.registerLogin;
            break;
        default:
            break;
    }
    return @"";
}

@end
