//
//  AppDelegate.m
//  JSBankCCYRemastered
//
//  Created by Jack on 2019/4/2.
//  Copyright © 2019 Jack. All rights reserved.
//

#import "AppDelegate.h"
#import "JSTabBarController.h"
#import "JSSplashScreenViewController.h"
/**
 *分享SDK
 */
#import "WXApi.h"
#import "WeiboSDK.h"
#import <ShareSDK/ShareSDK.h>
#import <ShareSDKConnector/ShareSDKConnector.h>

#import "PCDEncryptTokenManager.h"

@interface AppDelegate ()
@property(nonatomic, strong) UIView *coverView;

@end

@implementation AppDelegate

- (UIView *)coverView {
    if (!_coverView) {
        _coverView = [[UIView alloc] init];
        _coverView.frame = self.window.bounds;
        
        if (@available(iOS 8.0, *)) {
            UIBlurEffect *blur = [UIBlurEffect effectWithStyle:UIBlurEffectStyleLight];
            UIVisualEffectView *effectview = [[UIVisualEffectView alloc] initWithEffect:blur];
            effectview.frame = _coverView.frame;
            [_coverView addSubview:effectview];
        } else {
            UIToolbar *toolbar = [[UIToolbar alloc] initWithFrame:_coverView.frame];
            toolbar.barStyle = UIBarStyleDefault;
            [_coverView addSubview:toolbar];
        }
    }
    return _coverView;
}

- (BOOL)application:(UIApplication *)application didFinishLaunchingWithOptions:(NSDictionary *)launchOptions {
    // 启动图片延时: 1秒
//    [NSThread sleepForTimeInterval:2.0];


    [self initShareSDK];
    
    [self startRootView];
    [self initNetWorkConfig];

    return YES;
}

- (void)initNetWorkConfig {
    PCDNetWorkServiceGet().useEncrypt = YES;
    PCDNetWorkServiceGet().encyptScheme = @"v2";
    [PCDNetWorkServiceGet() start];
}

- (void)checkDevice {
    NSString *netMessage   = @"您正在使用wifi网络，请确保网络安全（您已切换至wifi网络，请确保网络安全）";
    NSString *breakMessage = @"您的设备为越狱状态，请您注意操作安全";

    if ([PCDevice isJailbreak] && [self isWifiNetwork]) {
        [JSDeftAlert showMessage:breakMessage afterDelay:2.5 completeHandle:^{
            [JSDeftAlert showMessage:netMessage afterDelay:2.5 completeHandle:nil];
        }];
    } else {
        if ([PCDevice isJailbreak]) {
            [JSDeftAlert showMessage:breakMessage afterDelay:2.5 completeHandle:nil];
        } else {
            if ([self isWifiNetwork]) {
                [JSDeftAlert showMessage:netMessage afterDelay:2.5 completeHandle:nil];
            }
        }
    }
}

- (BOOL)isWifiNetwork {
    return [ClientNetManager reachableStatus] == ReachableViaWiFi ? YES : NO;
}

- (void)initShareSDK {
    [ShareSDK registPlatforms:^(SSDKRegister *platformsRegister) {
        
        //微博
        [platformsRegister setupSinaWeiboWithAppkey:@"729557064"
                                          appSecret:@"59e3f5686eae268bd4331effb86d7947"
                                        redirectUrl:@"https://vbank.jsbchina.cn/wxcm/index.do"];
        
        //微信
        [platformsRegister setupWeChatWithAppId:@"wx9971e098cdaa49e7"
                                      appSecret:@"60abaf6330712ea730af2708b2d93575"];
    }];
}

#pragma mark - 初始化主页
- (void) startRootView {
    CGFloat buttonWidth = Width / 3 + 16;
    CGFloat buttonH     = 40;

    UILabel *label = [[UILabel alloc] init];
    label.backgroundColor = [UIColor colorWithRed:0.40 green:0.49 blue:0.91 alpha:1.00];
    label.frame = CGRectMake(0, 0, buttonWidth, buttonH);
    label.textAlignment = NSTextAlignmentCenter;
    label.textColor = [UIColor whiteColor];
    label.font = [UIFont systemFontOfSize:16];
    label.layer.shadowColor = [UIColor blackColor].CGColor;
    label.layer.shadowRadius = 3;
    label.layer.shadowOpacity = 0.3;
    label.layer.shadowOffset = CGSizeMake(-1, 3);
    label.layer.cornerRadius = label.frame.size.height / 2;
    label.layer.masksToBounds = YES;
    label.text = @"立即体验";
    
    __weak typeof(self) weakSelf = self;
    
    
    AppDelegate *appdele =(AppDelegate *)[UIApplication sharedApplication].delegate;
    UIWindow *rootWindow = appdele.window;
    
    if ([PCDGuidenceViewController appFirstLaunch]) {
        [PCDataCollectionManager shareModel].launchLogModel.IS_NEW_DEVICE = @"1";
        //引导页
        NSArray *resource = [self guidenceResource];
        PCDGuidenceViewController *guidenceVC =[[PCDGuidenceViewController alloc]initWithImagesName:resource];
        guidenceVC.pageControl.hidden = YES;
        guidenceVC.doneBtnImage = label.imageGraphics;
        guidenceVC.doneBtnOffset = CGPointMake(0, BANG_SCREEN ? 10 : 20);
        [guidenceVC setDismiss:^{
            [weakSelf initRootViewController];
        }];
        rootWindow.rootViewController = guidenceVC;
        [rootWindow makeKeyAndVisible];
    } else {
        [PCDataCollectionManager shareModel].launchLogModel.IS_NEW_DEVICE = @"0";
        //闪屏
        if ([JSSplashScreenViewController canShowImage]) {
            JSSplashScreenViewController *vc = [[JSSplashScreenViewController alloc] init];
            vc.dissmisBlock = ^{
                [weakSelf initRootViewController];
            };
            rootWindow.rootViewController = vc;
            [rootWindow makeKeyAndVisible];
        } else {
            [self initRootViewController];
        }
    }
}

- (NSArray *)guidenceResource {
    NSInteger imageCount = 4;
    NSMutableArray *imagesResource = [NSMutableArray array];
    NSString *screen_Resolution = SCREENSIZE_IS_XR ? @"828x1792" : ScreenResolution;//xr分辨率(750x1624)
    for (NSInteger index = 1; index < imageCount + 1; index++) {
        NSString *imageName = [NSString stringWithFormat:@"GuideImage%@-%ld.png",screen_Resolution,index];
        [imagesResource addObject:imageName];
    }
    return (NSArray *)imagesResource;
}

- (void)initRootViewController {
    JSTabBarController *tabBarController =[[JSTabBarController alloc]init];
    
    UINavigationController *rootNav =[[UINavigationController alloc] initWithRootViewController:tabBarController];
    rootNav.navigationBarHidden = YES;
    
    AppDelegate *appdele =(AppDelegate *)[UIApplication sharedApplication].delegate;
    UIWindow *rootWindow = appdele.window;
    rootWindow.rootViewController = rootNav;
    [rootWindow makeKeyAndVisible];
    
//    [self checkDevice];
    
    
//    [ClientNetManager fetchVersionUpdateWithSuccess:^(id resultResponse, id resultModel) {
//
//    } failure:^(NSError *error, LoginSession *session) {
//
//    }];
}

- (void)applicationWillResignActive:(UIApplication *)application {
    // Sent when the application is about to move from active to inactive state. This can occur for certain types of temporary interruptions (such as an incoming phone call or SMS message) or when the user quits the application and it begins the transition to the background state.
    // Use this method to pause ongoing tasks, disable timers, and invalidate graphics rendering callbacks. Games should use this method to pause the game.
    NSLog(@"applicationWillResignActive");

}


- (void)applicationDidEnterBackground:(UIApplication *)application {
    // Use this method to release shared resources, save user data, invalidate timers, and store enough application state information to restore your application to its current state in case it is terminated later.
    // If your application supports background execution, this method is called instead of applicationWillTerminate: when the user quits.
    NSLog(@"applicationDidEnterBackground");
    [[UIApplication sharedApplication].delegate.window addSubview:self.coverView];
}


- (void)applicationWillEnterForeground:(UIApplication *)application {
    // Called as part of the transition from the background to the active state; here you can undo many of the changes made on entering the background.
    NSLog(@"applicationWillEnterForeground");
    if (_coverView) {
        [_coverView removeFromSuperview];
        _coverView = nil;
    }
}


- (void)applicationDidBecomeActive:(UIApplication *)application {
    // Restart any tasks that were paused (or not yet started) while the application was inactive. If the application was previously in the background, optionally refresh the user interface.
    NSLog(@"applicationDidBecomeActive");
    
}


- (void)applicationWillTerminate:(UIApplication *)application {
    NSLog(@"applicationWillTerminate");

    // Called when the application is about to terminate. Save data if appropriate. See also applicationDidEnterBackground:.
}


@end
