//
//  NBLogin.m
//  PCDBank
//
//  Created by 王俣 on 2018/8/22.
//  Copyright © 2018年 yt. All rights reserved.
//

#import "PCDLogin.h"

@implementation PCDLogin

- (void)handler:(id)data andContext:(PCDContext *)context ResponseCallback:(WVJBResponseCallback )responseCallback {
    JSBaseWebViewController *webV = (JSBaseWebViewController *)context.viewController;
    NSDictionary *dict = (NSDictionary *)data;
    if (!dict.notNull) {return;}
    NSString *callback = [dict objectForKey:@"callback"];
    NSString *backurl = [dict objectForKey:@"backurl"];

    [JSLoginManager clientLoginWithTarget:webV success:^(id  _Nonnull resultResponse, LoginSession * _Nonnull session) {
        [webV.tabBarController.navigationController popViewControllerAnimated:NO];
        if (!callback.notNull) {
            if ([callback isEqualToString:@"shop"]) {
                [self fetchShopDataWithSubUrl:backurl];
            } else {
                evaluateJavaScriptOnMainThread(self, callback, @"");
            }
        }
    } faild:nil];
}

- (void)fetchShopDataWithSubUrl:(NSString *)subUrl {
    [ClientNetManager fetchShopDataSuccess:^(id resultResponse, ShopModel *shopModel) {
        NSString *fullUrl = [NSString stringWithFormat:@"%@?authdata=%@&signdata=%@", subUrl, shopModel.confirmTransferDataSTR, shopModel.submitTransferDataSTR];
        [self goWebViewWithUrl:fullUrl];
    } failure:^(NSString *MSG, ShopModel *shopModel) {
        
    }];
}

- (void)goWebViewWithUrl:(NSString *)url {
    if (!url.notNull) {
        return;
    }
    if (![url hasPrefix:@"https://"] && ![url hasPrefix:@"http://"]) {
        url = [PCDUtil js_getPublicServerURL:url];
    }
    NSDictionary *param = @{@"url" : url};
    NSDictionary *expando = [PCDUtil IsIphoneX]?@{@"NSLayoutAttributeTop":@"88"}:@{@"NSLayoutAttributeTop":@"64"};
    
    JSBaseWebViewController *webVC = [PCDWServiceGet() createPCDViewController:param viewControllerClass:[JSBaseWebViewController class] contentViewClass:nil withExpando:expando];
    UIWindow *window = [UIApplication sharedApplication].delegate.window;
    UINavigationController *navi = (UINavigationController *)window.rootViewController;
    [navi pushViewController:webVC animated:YES];
}

@end
