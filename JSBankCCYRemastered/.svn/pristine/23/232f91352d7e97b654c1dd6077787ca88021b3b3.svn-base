//
//  SaveImagePlugin.m
//  JSBankCCYRemastered
//
//  Created by Jack on 2019/5/9.
//  Copyright © 2019 Jack. All rights reserved.
//

#import "SaveImagePlugin.h"
#import "DJAlbumManager.h"

@interface SaveImagePlugin ()

@end

@implementation SaveImagePlugin

- (void)handler:(id)data andContext:(PCDContext *)context ResponseCallback:(WVJBResponseCallback )responseCallback {
    NSString *jsonString = (NSString *)data;
    if (!jsonString.notNull) {return;}

    NSDictionary *dict = [jsonString JSONValue];
    NSString *base64String = [dict objectForKey:@"imgSrc"];
    if (!base64String.notNull) {return;}

    UIImage *base64Image = [self getImageWithBase64String:base64String];
    [DJAlbumManager saveImageToCustomPhotoWithImage:base64Image folderName:@"串串盈" complete:^(PHAlbumState state) {
        if (state == PHAlbumStateSaveSuccess) {
            [JSDeftAlert js_showMessage:@"保存相册成功" isCentered:YES afterDelay:2.5 completeHandle:nil];
        } else {
            if (state == PHAlbumStateUserAuthorAgain) {
                [JSDeftAlert showAlert:@"请在设置->串串盈->照片中开启权限" doneTitle:@"确定" cancelTitle:nil doneHandle:nil cancelHandle:nil];
            }
        }
    }];
}

- (UIImage *)getImageWithBase64String:(NSString *)string {
    NSData * imageData =[[NSData alloc] initWithBase64EncodedString:string options:NSDataBase64DecodingIgnoreUnknownCharacters];
    UIImage *imageScr = [UIImage imageWithData:imageData ];
    
    return imageScr;
}

@end
