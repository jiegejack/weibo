//
//  JSLoginManager.m
//  JSBankCCYRemastered
//
//  Created by Jack on 2019/5/6.
//  Copyright © 2019 Jack. All rights reserved.
//

#import "JSLoginManager.h"
#import "JSLoginViewController.h"
#import "TouchIDManager.h"
#import "JSSettingPasswordViewController.h"
#import "JSFaceRecordViewController.h"
#import "JSTabBarController.h"

@implementation JSLoginManager

static NSDictionary     *_loginParam;
static LoginType         _type;
static UIViewController *_target;

+ (BOOL)clientIsLogin {
    NSInteger status = [JSSharedInstance sharedInstance].loginSession.STATUS.integerValue;
    
    return status ? YES : NO;
}

+ (void)logoutClient {
    if ([JSSharedInstance sharedInstance].loginSession.STATUS.integerValue == 1) {
        [JSSharedInstance sharedInstance].loginSession = nil;
//        [PNCMBankGlobal sharedData].openid=nil;
//        [PNCMBankGlobal sharedData].openURL=nil;
//        [PNCMBankGlobal sharedData].headImageURL=nil;
        [self reloadRootViewControllers];
    }
}

+ (void)reloadRootViewControllers {
    UIWindow *window= [[[UIApplication sharedApplication] delegate] window];
    UINavigationController *navi = (UINavigationController *)window.rootViewController;
    PCDTabBarController *tabBarController = (PCDTabBarController *)navi.viewControllers.firstObject;
    if (window.rootViewController) {
        for (UINavigationController *nav in tabBarController.viewControllers) {
            if ([nav.viewControllers.firstObject isKindOfClass:[JSRootWebViewController class]]) {
                JSRootWebViewController *rootVC=(JSRootWebViewController *)nav.viewControllers.firstObject;
                [rootVC doWebRequest];
            }
        }
    }
}

+ (void)reloadCurrentPage {
    UIWindow *window = [UIApplication sharedApplication].delegate.window;
    UINavigationController *navi = (UINavigationController *)window.rootViewController;
    id vc = navi.viewControllers.lastObject;
    JSBaseWebViewController *baseWebVC;

    if ([vc isKindOfClass:[JSBaseWebViewController class]]) {
        baseWebVC = vc;
    }
    if ([vc isKindOfClass:[JSTabBarController class]]) {
        JSTabBarController *tabBar = vc;
        if ([tabBar.selectedViewController isKindOfClass:[JSBaseWebViewController class]]) {
            baseWebVC = tabBar.selectedViewController;
        }
    }
    if ([baseWebVC respondsToSelector:@selector(doWebRequest)]) {
        [baseWebVC doWebRequest];
    }
}

+ (void)indexToHomePage:(NSInteger)page {
    UIWindow *window = [UIApplication sharedApplication].delegate.window;
    UINavigationController *navi = (UINavigationController *)window.rootViewController;
    [navi popToRootViewControllerAnimated:NO];
    JSTabBarController *tabBarController = (JSTabBarController *)navi.viewControllers.lastObject;
    tabBarController.tabBar.selectedItem = tabBarController.tabBar.items[page];
    tabBarController.selectedIndex = page;
    tabBarController.currentSelectedIndex = page;
}

+ (UINavigationController *)getNavi {
    UIWindow *window = [UIApplication sharedApplication].delegate.window;
    UINavigationController *navi = (UINavigationController *)window.rootViewController;
    JSTabBarController *tabBarController = (JSTabBarController *)navi.viewControllers.lastObject;
    return tabBarController.navigationController;
}

+ (void)clientLoginSuccess:(nullable void(^)(id resultResponse, LoginSession *session))success
                        faild:(nullable void(^)(NSString *MSG, LoginSession *session, id resultResponse))faild {
    
    JSLoginViewController *vc = [[JSLoginViewController alloc] initWithSuccessBlock:^(id resultResponse, LoginSession *session) {
        if (success) {
            success(resultResponse, session);return;
        }
        [[self getNavi] popViewControllerAnimated:NO];
    } faildBlock:^(NSString *MSG, LoginSession *session, id resultResponse) {
        if (faild) {
            faild(MSG, session, resultResponse);
        }
    }];
    if (([TouchIDManager biometryType] != DJBiometryTypeNotSupport) && [TouchIDManager getBiometryState]) {
        vc.isBiometryLoginInterface = YES;
    }
    vc.hidesBottomBarWhenPushed = YES;
    [[self getNavi] pushViewController:vc animated:YES];
}

+ (void)loginWithLoginType:(LoginType)type
                loginParam:(NSDictionary *)loginParam
                   success:(nullable void(^)(id resultResponse, LoginSession *session))success
                     faild:(nullable void(^)(NSString *MSG, LoginSession *session, id resultResponse))faild {

    if (type != LoginTypeBiometry && !loginParam.notNull) {return;}

    _loginParam = loginParam;
//    _target     = target;
    _type       = type;
    
    NSString *loadText = type == LoginTypeRegister ? @"请稍后..." : @"登录中...";
    [LoadIndicator showLoadingIndicatorWithText:loadText shouldTap:YES];
    
    __weak typeof(self) weakSelf = self;
    __block NSString *msg = @"";
    [ClientNetManager fetchLoginDataWithParam:[self setLoginParamWithType:type]
                                  RequestPath:[self loginPathWithType:type]
                                      success:^(id resultResponse, id resultModel) {
                                          
        LoginSession *session = (LoginSession *)resultModel;
        if (!session) {return;}
        [JSSharedInstance sharedInstance].loginSession = session;
        [DataCache setCacheString:session.custemployeNo ? session.custemployeNo : @"" forkey:@"ccy_custemployeNo"];
        
        msg = type == LoginTypeRegister ? @"注册成功" : @"登录成功";
                                          
        [self reloadRootViewControllers];
                                          
        if (success) {
            success(resultResponse, session);
        }
                                          
        [weakSelf showMsg:msg session:session];
    } failure:^(NSString *MSG, LoginSession *session, id resultResponse) {
        if ([session.STATUS isEqualToString:@"FQZ02"] || //加强认证
            [session.STATUS isEqualToString:@"FQZ04"]) { //视频认证
            
            [weakSelf showAuthenticationWithFlag:session.STATUS];
        } else {
            msg = MSG;
        }
        [weakSelf showMsg:msg session:session];
        if (faild) {
            faild(MSG, session, nil);
        }
    }];
}

+ (void)showMsg:(NSString *)msg session:(LoginSession *)session {
    if (msg.notNull) {
        __weak typeof(self) weakSelf = self;
        [JSDeftAlert showMessage:msg afterDelay:1.5 completeHandle:^{
            if (_type == LoginTypeRegister && session.STATUS.integerValue == 1) {
                [JSDeftAlert showAlert:@"请设置登录密码" doneTitle:@"确定" cancelTitle:nil doneHandle:^{
                    [weakSelf gotoSettingPwd];
                } cancelHandle:nil];
            }
        }];
    }
}

+ (void)showAuthenticationWithFlag:(NSString *)flag {
    __weak typeof(self) weakSelf = self;
    AlertExtension *alert = [[[AlertExtension alloc] init] alertWithTitle:@"温馨提示"
                                                                  message:@"为保证您的账户安全，请选择验证方式。" type:AlertTypeRegular];
    alert.titleFont = [UIFont boldSystemFontOfSize:17];
    alert.messageFont = [UIFont systemFontOfSize:15];
    
    alert.cancelButtonTitle = @"取消";
    alert.otherButtonTitle = @"去认证";
    
    alert.otherBlock = ^{
        if ([flag isEqualToString:@"FQZ04"]) {
            UIWindow *window = [UIApplication sharedApplication].delegate.window;
            UINavigationController *navi = (UINavigationController *)window.rootViewController;
//
//            [navi popViewControllerAnimated:NO];
            
            JSFaceRecordViewController *faceVC = [[JSFaceRecordViewController alloc]init];
            faceVC.type       = @"03";
            faceVC.loginParam = _loginParam;
            faceVC.loginType  = _type;
            [navi pushViewController:faceVC animated:YES];
        }
        if ([flag isEqualToString:@"FQZ02"]) {
            [weakSelf excuteAuthenticationWithFlag:flag];
        }
    };
    [alert showAlert];
}

+ (void)excuteAuthenticationWithFlag:(NSString *)flag {
    NSString *mobileNo = [_loginParam objectForKey:@"mobileNo"];
    mobileNo = mobileNo.notNull ? mobileNo : @"";
    
    NSString *url = [PCDUtil js_getPublicServerURL:[NSString stringWithFormat:@"page/PP01/PP0105/PP0105.html?validateType=msg&mobileNo=%@&smsType=login", mobileNo]];
    
    NSDictionary *param = @{@"url" : url};
    NSDictionary *expando = [PCDUtil IsIphoneX]?@{@"NSLayoutAttributeTop":@"88"}:@{@"NSLayoutAttributeTop":@"64"};

    JSBaseWebViewController *webVC = [PCDWServiceGet() createPCDViewController:param viewControllerClass:[JSBaseWebViewController class] contentViewClass:nil withExpando:expando];
    UIWindow *window = [UIApplication sharedApplication].delegate.window;
    UINavigationController *navi = (UINavigationController *)window.rootViewController;
    [navi pushViewController:webVC animated:YES];
}

+ (void)gotoSettingPwd {
    UIWindow *window = [UIApplication sharedApplication].delegate.window;
    UINavigationController *navi = (UINavigationController *)window.rootViewController;
    JSSettingPasswordViewController *setVC = [[JSSettingPasswordViewController alloc] init];
    [navi pushViewController:setVC animated:YES];
}

+ (NSMutableDictionary *)setLoginParamWithType:(LoginType)type {
    NSMutableDictionary *param = [NSMutableDictionary dictionary];

    switch (type) {
        case LoginTypePassword:
            param = Param().pwdLogin;
            [param setObject:[self setPhoneNo] forKey:@"mobileNo"];
            [param setObject:[self setLoginPassword] forKey:@"loginPassword"];
            break;
        case LoginTypeBiometry:
            param = Param().biometryLogin.mutableCopy;
            break;
        case LoginTypeCode:
            param = Param().codeLogin;
            [param setObject:[self setSMSCode] forKey:@"code"];
            [param setObject:[self setPhoneNo] forKey:@"mobileNo"];
            break;
        case LoginTypeRegister:
            param = Param().registerLogin;
            [param setObject:[self setSMSCode] forKey:@"code"];
            [param setObject:[self setPhoneNo] forKey:@"mobileNo"];
            [param setObject:[self setRecommend] forKey:@"recommend"];
            break;  
        default:
            break;
    }
    [param setObject:@"iOS"  forKey:@"LoginChannel"];
    [param setObject:@"0006" forKey:@"developChannel"];

    return param;
}
+ (NSString *)setSMSCode {
    NSString *code = [_loginParam objectForKey:@"code"];
    code = code.notNull ? code : @"";
    
    return code;
}
+ (NSString *)setLoginPassword {
    NSString *pwd = [_loginParam objectForKey:@"loginPassword"];
    pwd = pwd.notNull ? pwd : @"";
    
    return pwd;
}

+ (NSString *)setRecommend {
    NSString *recommend = [_loginParam objectForKey:@"recommend"];
    recommend = recommend.notNull ? recommend : @"";

    return recommend;
}
+ (NSString *)setPhoneNo {
    NSString *phoneNo = [_loginParam objectForKey:@"mobileNo"];
    phoneNo = phoneNo.notNull ? phoneNo : @"";
    
    return phoneNo;
}

+ (NSString *)loginPathWithType:(LoginType)type {
   switch (type) {
        case LoginTypePassword:
            return Request().loginPassword;
            break;
        case LoginTypeBiometry:
            return Request().biometryLogin;
            break;
        case LoginTypeCode:
            return Request().SMSCodeLogin;
            break;
        case LoginTypeRegister:
            return Request().registerLogin;
            break;
        default:
            break;
    }
    return @"";
}

@end
