//
//  ClientNetManager.m
//  JSBankQNXY
//
//  Created by Jack on 2019/04/15.
//  Copyright © 2019 Jack. All rights reserved.
//

#import "ClientNetManager.h"
#import <objc/runtime.h>
#import "MJExtension.h"
#import "LoginSession.h"
#import "RequestConfig.h"
#import "TabBarModel.h"

@implementation ClientNetManager
static RequestConfig *config;

+ (void)initialize {
    config = [[RequestConfig alloc] init];
}


+ (void)fetchFaceRecordDataWithImage:(UIImage *)image
                            mobileNo:(NSString *)mobileNo
                             success:(void (^)(id resultResponse, FaceRecord *faceRecord))success
                             failure:(void (^)(NSError *error, FaceRecord *faceRecord))failure {
    
    
    NSData *data=UIImageJPEGRepresentation(image, 0.2f);
    
    NSString *encodedImageStr = [data base64EncodedStringWithOptions:NSDataBase64Encoding64CharacterLineLength];
    
    NSDictionary *param = @{@"TYPE"         : @"03",
                            @"mobileNo"     : mobileNo,
                            @"IMAGE_BEST"   : encodedImageStr,
                            @"LoginChannel" : @"iOS"};
    
    [self publicFetchDataWithRequestPath:config.faceRecord
                                   param:param
                             resultModel:[FaceRecord class]
                                 success:^(id resultResponse, id resultModel) {
                                     
        if (success) {
            success(resultResponse, resultModel);
        }
    } failure:^(NSError *error, id resultModel, id resultResponse) {
        if (failure) {
            failure(error, resultModel);
        }
    }];
}

+ (void)fetchTabBarIconWithSuccess:(void (^)(id resultResponse, id resultModel))success
                           failure:(void (^)(NSError *error, LoginSession *session, id resultResponse))failure {
    
    NSDictionary *param = @{@"channel"  : @"1"};
    
    [self publicFetchDataWithRequestPath:config.tabBarIcon
                            param:param
                      resultModel:[TabBarModel class]
                          success:^(id resultResponse, id resultModel) {
                              
        if (success) {
            success(resultResponse, resultModel);
        }
    } failure:^(NSError *error, id resultModel, id resultResponse) {
        if (failure) {
            failure(error, resultModel, resultResponse);
        }
    }];
}

+ (void)fetchVersionUpdateWithSuccess:(void (^)(id resultResponse, id resultModel))success
                              failure:(void (^)(NSError *error, LoginSession *session, id resultResponse))failure {
    
//    NSDictionary *param = @{@"mobile" : phoneNO,
//                            @"type"   : @"register",
//                            @"flag"   : @"0",
//                            @"code"   : code};
    
    [self publicFetchDataWithRequestPath:config.versionUpdate
                            param:nil
                      resultModel:nil
                          success:^(id resultResponse, id resultModel) {
      
      if (success) {
          success(resultResponse, resultModel);
      }
  } failure:^(NSError *error, id resultModel, id resultResponse) {
      if (failure) {
          failure(error, resultModel, resultResponse);
      }
  }];
}

+ (void)fetchSettingPasswordDataWithPwd:(NSString *)pwd
                              verifyPwd:(NSString *)vPwd
                                success:(void (^)(id resultResponse, id resultModel))success
                                failure:(void (^)(NSError *error, LoginSession *session, id resultResponse))failure {
    
    NSString *custemployeNo = [JSSharedInstance sharedInstance].loginSession.custemployeNo;
    custemployeNo = custemployeNo.notNull ? custemployeNo : @"";
    NSDictionary *param = @{@"transChannel"  : @"iOS",
                            @"loginflag"     : @"3",
                            @"checkflag"     : @"2",
                            @"password"      : pwd,
                            @"repassword"    : vPwd,
                            @"custemployeNo" : custemployeNo};
    
    [self publicFetchDataWithRequestPath:config.setPassword
                            param:param
                      resultModel:nil
                          success:^(id resultResponse, id resultModel) {
                              
        if (success) {
            success(resultResponse, resultModel);
        }
    } failure:^(NSError *error, id resultModel, id resultResponse) {
        if (failure) {
            failure(error, resultModel, resultResponse);
        }
    }];
}

+ (void)fetchRegistDataWithPhoneNO:(NSString *)phoneNO1
                    recommentPhone:(NSString *)phoneNO2
                              code:(NSString *)code
                           success:(void (^)(id resultResponse, id resultModel))success
                           failure:(void (^)(NSError *error, LoginSession *session, id resultResponse))failure {
    
    phoneNO1 = phoneNO1.notNull ? phoneNO1 : @"";
    phoneNO2 = phoneNO2.notNull ? phoneNO2 : @"";
    code     = code.notNull     ? code     : @"";
    
    NSDictionary *param = @{@"code"      : code,
                            @"mobileNo"  : phoneNO1,
                            @"recommend" : phoneNO2};
    
    [JSLoginManager loginWithLoginType:LoginTypeRegister loginParam:param target:nil success:^(id  _Nonnull resultResponse, LoginSession * _Nonnull session) {
        if (success) {
            success(resultResponse, session);
        }
    } faild:^(NSError * _Nonnull error, LoginSession * _Nonnull session, id resultResponse) {
        if (failure) {
            failure(error, session, resultResponse);
        }
    }];
}

+ (void)fetchSMSCodeDataWithPhoneNO:(NSString *)phoneNO
                               code:(NSString *)code
                               type:(NSInteger)type
                            success:(void (^)(id resultResponse, id resultModel))success
                            failure:(void (^)(NSError *error, LoginSession *session, id resultResponse))failure {
    
    NSDictionary *param = @{@"mobile" : phoneNO,
                            @"type"   : type ? @"register" : @"login",
                            @"flag"   : type ? @"0" : @"3",
                            @"code"   : code};
    NSLog(@"注册参数param : %@",param);
    [self publicFetchDataWithRequestPath:config.SMSCode
                            param:param
                      resultModel:nil
                          success:^(id resultResponse, id resultModel) {
                              
          if (success) {
              success(resultResponse, resultModel);
          }
      } failure:^(NSError *error, id resultModel, id resultResponse) {
          if (failure) {
              failure(error, resultModel, resultResponse);
          }
      }];
}

+ (void)fetchPlaceholderContentWithSuccess:(void (^)(id resultResponse, id resultModel))success
                                   failure:(void (^)(NSError *error, LoginSession *session, id resultResponse))failure {
    
    [self publicFetchDataWithRequestPath:config.placeholder
                            param:nil
                      resultModel:nil
                          success:^(id resultResponse, id resultModel) {
                              
        if (success) {
            success(resultResponse, resultModel);
        }
    } failure:^(NSError *error, id resultModel, id resultResponse) {
        if (failure) {
            failure(error, resultModel, resultResponse);
        }
    }];
}

+ (void)fetchSplashScreenImageWithUrl:(NSString *)url
                              success:(void (^)(id resultResponse))success
                              failure:(void (^)(NSError *error, LoginSession *session, id resultResponse))failure {
    
    PCDNetWorkItem *tempItem = [[PCDNetWorkItem alloc] init];
    tempItem.urlString       = url;
    tempItem.completionBlock = ^(PCDNetWorkItem *object) {
        NSData *dataStr      = object.responseData;
        if (success) {
            success(dataStr);
        }
    };
    [PCDNetWorkServiceGet() addNetWork:tempItem];
}

+ (void)fetchSplashScreenDataWithSuccess:(void (^)(id resultResponse, id resultModel))success
                                 failure:(void (^)(NSError *error, LoginSession *session, id resultResponse))failure {
    
    NSDictionary *param = @{@"OS" : @"channel_type_iphone"};
    
    [self publicFetchDataWithRequestPath:0
                            param:param
                      resultModel:nil
                          success:^(id resultResponse, id resultModel) {
                              
        if (success) {
            success(resultResponse, resultModel);
        }
    } failure:^(NSError *error, id resultModel, id resultResponse) {
        if (failure) {
            failure(error, resultModel, resultResponse);
        }
    }];
}

+ (void)fetchLoginDataWithParam:(NSDictionary *)param
                       RequestPath:(NSString *)path
                        success:(void (^)(id resultResponse, id resultModel))success
                        failure:(void (^)(NSError *error, LoginSession *session, id resultResponse))failure {
    
    __weak typeof(self) weakSelf = self;

    [self publicFetchDataWithRequestPath:path
                                   param:param
                             resultModel:[LoginSession class]
                                 success:^(id resultResponse, id resultModel) {
                   
        [weakSelf loginTimeoutWithSession:(LoginSession *)resultModel];
        if (success) {
            success(resultResponse, resultModel);
        }
    } failure:^(NSError *error, LoginSession *session, id resultResponse) {
        if (failure) {
            failure(error, session, resultResponse);
        }
    }];
}

+ (void)publicFetchDataWithRequestPath:(NSString *)path
                          param:(NSDictionary *)param
                    resultModel:(Class)resultModel
                        success:(void (^)(id resultResponse, id resultModel))success
                        failure:(void (^)(NSError *error, id resultModel, id resultResponse))failure {
    
    param = param.notNull ? param : @{};
    [ClientNetManager requstWithRequestPath:[PCDUtil getServerURL:path]
                       requestParam:param
              requestCompleteHandle:^(NSDictionary *resultDataDict) {
                  
        id modelClass = [self getModelClass:resultModel];
        if (resultModel && modelClass) {
            if ([resultDataDict isKindOfClass:[NSArray class]]) {
                NSMutableArray *dataArray = [modelClass mj_objectArrayWithKeyValuesArray:(NSArray *)resultDataDict];
                if (success) {
                    success(resultDataDict, dataArray);
                }
            } else {
                modelClass = [modelClass mj_objectWithKeyValues:(NSDictionary *)resultDataDict];
                if (success) {
                    success(resultDataDict, modelClass);
                }
            }
        } else {
            if (success) {
                success(resultDataDict, nil);
            }
        }
    } requestFailedHandle:^(NSError *error, id resultModel, id resultResponse) {
        if (failure) {
            failure(error, resultModel, resultResponse);
        }
    }];
}

+ (void)requstWithRequestPath:(NSString *)path
      requestParam:(NSDictionary *)param
requestCompleteHandle:(void(^)(NSDictionary * resultDataDict))completeHandle
  requestFailedHandle:(void(^)(NSError *error, id resultModel, id resultResponse))faileHandle {
    
//    if ([self reachableStatus] == NotReachable)
//    {
//        [JSDeftAlert showAlert:@"请检查您的网络连接或稍后再试" doneTitle:@"确定" cancelTitle:nil doneHandle:nil cancelHandle:nil];
//        return;
//    }
    
    [PCDNetWorkServiceGet() sendRequestWithUrlString:path requestType:REQUEST_METHOD_DEFAULT contentType:REQUEST_CONTENTTYPE_DEFAULT configEncryptBlock:^NSString * _Nonnull(NSString * _Nonnull unencryptJsonString) {
        return nil;
    } body:param andCompletionBlock:^(PCDNetWorkItem * _Nonnull item, BOOL success) {
        dispatch_async(dispatch_get_main_queue(), ^{
            [LoadIndicator hiddenLoadingIndicator];
            
            NSDictionary *dict = [item.responseString JSONValue];
            dict = [dict objectForKey:@"body"];
            NSString *status = [dict objectForKey:@"STATUS"];
            if (status.integerValue == 1) {
                if (success) {
                    if (completeHandle) {
                        completeHandle(dict);
                    }
                }
            } else {
                if (faileHandle) {
                    faileHandle(item.error, nil, dict);
                }
                
            }
        });
    }];
}

//判断网络连接状态
//+ (NetworkStatus)reachableStatus
//{
//    Reachability *reachable = [Reachability reachabilityForInternetConnection];
//    switch ([reachable currentReachabilityStatus]) {
//        case NotReachable:
//            return NotReachable;
//        case ReachableViaWWAN:
//            return ReachableViaWWAN;
//        case ReachableViaWiFi:
//            return ReachableViaWiFi;
//        default:
//            break;
//    }
//}

+ (void)loginTimeoutWithSession:(LoginSession *)session {
    if ([session.STATUS isEqualToString:@"login_out"]) {
        [JSDeftAlert showAlert:session.MSG doneTitle:@"确定" cancelTitle:nil doneHandle:^{
            [JSLoginManager indexToHomePage:0];
            [JSLoginManager logoutClient];
        } cancelHandle:nil];
    }
}

+ (id)getModelClass:(Class)model {
    if (model) {
        NSString *class = NSStringFromClass([model class]);
        const char *className = [class cStringUsingEncoding:NSASCIIStringEncoding];
        Class modelClass = objc_getClass(className);
        
        return modelClass;
    }
    return nil;
}


@end
